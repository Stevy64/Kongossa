{% extends 'base.html' %}
{% load chat_filters %}

{% block title %}Chat - {{ other_user.username }} - Kongossa{% endblock %}

{% block extra_css %}
<!-- Masquer les messages d'alerte dans la messagerie -->
<style>
    .fixed.top-4.right-4 {
        display: none !important;
    }
    
    /* D√©grad√© bleu/vert pour le fond de messagerie avec animations */
    .chat-bg-gradient {
        background: linear-gradient(135deg, #1B263B 0%, #0D1B2A 25%, #1B263B 50%, #0D1B2A 75%, #1B263B 100%);
        background-size: 400% 400%;
        animation: chat-gradient-shift 20s ease infinite;
        min-height: 100vh;
        position: relative;
    }
    
    .chat-bg-gradient::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: 
            radial-gradient(circle at 15% 25%, rgba(59, 130, 246, 0.12) 0%, transparent 45%),
            radial-gradient(circle at 85% 75%, rgba(74, 222, 128, 0.1) 0%, transparent 45%),
            radial-gradient(circle at 50% 50%, rgba(59, 130, 246, 0.05) 0%, transparent 50%);
        animation: chat-pulse 10s ease-in-out infinite;
        pointer-events: none;
    }
    
    .chat-bg-gradient > * {
        position: relative;
        z-index: 1;
    }
    
    @keyframes chat-gradient-shift {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }
    
    @keyframes chat-pulse {
        0%, 100% {
            opacity: 1;
            transform: scale(1);
        }
        50% {
            opacity: 0.8;
            transform: scale(1.05);
        }
    }
    
    /* Glassmorphism pour messagerie */
    .glass-card {
        background: rgba(27, 38, 59, 0.7);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 4px 20px rgba(13, 27, 42, 0.4);
    }
    
    /* Tab bar plus fonc√©e pour messagerie */
    .glass-card.tab-bar {
        background: rgba(13, 27, 42, 0.98);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-top: 1px solid rgba(255, 255, 255, 0.15);
        box-shadow: 0 -4px 25px rgba(0, 0, 0, 0.4);
    }
    
    /* Container de chat */
    .chat-container {
        height: calc(100vh - 80px);
        display: flex;
        flex-direction: column;
        min-height: 0;
        overflow: hidden;
    }
    
    @media (max-width: 768px) {
        .chat-container {
            height: calc(100vh - 60px);
        }
        
        /* Am√©liorer la zone de saisie sur mobile */
        .glass-card.tab-bar {
            padding: 0.75rem;
        }
        
        /* Input plus grand et lisible sur mobile */
        #chat-message-input {
            font-size: 16px !important; /* √âvite le zoom automatique sur iOS */
            min-height: 2.5rem !important;
            padding: 0.625rem 0.875rem !important;
        }
        
        /* Boutons plus grands et espac√©s sur mobile */
        .glass-card.tab-bar button,
        .glass-card.tab-bar .flex button {
            min-width: 2.5rem;
            min-height: 2.5rem;
            padding: 0.5rem;
        }
        
        /* Messages plus lisibles sur mobile */
        .message-bubble {
            max-width: 90% !important;
            padding: 0.875rem 1rem !important;
            font-size: 0.9375rem;
        }
        
        /* Header plus compact sur mobile */
        header.glass-card {
            padding: 0.5rem 0.75rem;
        }
        
        /* Zone de messages avec padding adapt√© */
        .messages-container {
            padding: 0.75rem;
        }
    }
    
    /* Optimisation pour tr√®s petits √©crans */
    @media (max-width: 375px) {
        .chat-container {
            height: calc(100vh - 50px);
        }
        
        #chat-message-input {
            font-size: 16px !important;
            padding: 0.5rem 0.75rem !important;
        }
        
        .message-bubble {
            max-width: 95% !important;
            padding: 0.75rem 0.875rem !important;
        }
    }
    
    /* Zone des messages */
    .messages-container {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 0.5rem 0.75rem;
        background: rgba(255, 255, 255, 0.05);
        min-height: 0;
    }
    
    @media (min-width: 768px) {
        .messages-container {
            padding: 0.75rem 1rem;
        }
    }
    
    /* Bulles de message */
    .message-bubble {
        max-width: 95%;
        word-wrap: break-word;
        word-break: break-word;
        animation: fadeIn 0.3s ease-in;
        line-height: 1.4;
        font-size: 0.9375rem;
    }
    
    @media (min-width: 768px) {
        .message-bubble {
            max-width: 90%;
            padding: 0.875rem 1.25rem;
        }
    }
    
    @media (min-width: 1024px) {
        .message-bubble {
            max-width: 88%;
        }
    }
    
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Message envoy√© - Style WhatsApp/Telegram */
    .message-sent {
        margin-left: auto;
        margin-right: 0 !important;
        background: linear-gradient(135deg, #3390EC 0%, #5EB5F7 100%);
        color: white;
        border-radius: 7.5px 7.5px 0 7.5px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        font-weight: 400;
        position: relative;
        align-self: flex-end;
        padding: 0.5rem 0.625rem 0.375rem 0.625rem;
        margin-bottom: 0.125rem;
    }
    
    /* Message re√ßu - Style WhatsApp/Telegram */
    .message-received {
        margin-left: 0 !important;
        margin-right: auto;
        background: rgba(255, 255, 255, 0.12);
        backdrop-filter: blur(10px);
        color: #E4E6EB;
        border-radius: 0 7.5px 7.5px 7.5px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        font-weight: 400;
        position: relative;
        align-self: flex-start;
        padding: 0.5rem 0.625rem 0.375rem 0.625rem;
        margin-bottom: 0.125rem;
    }
    
    /* Am√©lioration du texte dans les bulles */
    .message-bubble p,
    .message-bubble span,
    .message-bubble div {
        color: inherit;
    }
    
    /* Liens dans les messages */
    .message-bubble a {
        color: inherit;
        text-decoration: underline;
        opacity: 0.9;
        transition: opacity 0.2s;
    }
    
    .message-bubble a:hover {
        opacity: 1;
    }
    
    /* Scrollbar personnalis√©e */
    .messages-container::-webkit-scrollbar {
        width: 6px;
    }
    
    .messages-container::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
    }
    
    .messages-container::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 10px;
    }
    
    .messages-container::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.5);
    }
    
    /* Typing indicator */
    .typing-indicator {
        display: none;
        padding: 0.5rem 1rem;
        margin-bottom: 0.5rem;
    }
    
    .typing-indicator.active {
        display: block;
    }
    
    .typing-dots {
        display: inline-flex;
        gap: 4px;
    }
    
    .typing-dots span {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: rgba(0, 0, 0, 0.4);
        animation: typing 1.4s infinite;
    }
    
    .typing-dots span:nth-child(2) {
        animation-delay: 0.2s;
    }
    
    .typing-dots span:nth-child(3) {
        animation-delay: 0.4s;
    }
    
    @keyframes typing {
        0%, 60%, 100% {
            transform: translateY(0);
            opacity: 0.7;
        }
        30% {
            transform: translateY(-10px);
            opacity: 1;
        }
    }
    
    /* Sidebar minimis√©e - Plus fonc√©e */
    .sidebar-minimized {
        width: 80px;
        background: rgba(13, 27, 42, 0.95);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-right: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .sidebar-expanded {
        width: 320px;
        background: rgba(13, 27, 42, 0.95);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-right: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 4px 0 20px rgba(0, 0, 0, 0.3);
    }
    
    @media (max-width: 768px) {
        .sidebar-minimized {
            width: 0;
            transform: translateX(-100%);
        }
        .sidebar-expanded {
            width: 100%;
            max-width: 320px;
            position: fixed;
            z-index: 50;
        }
    }
</style>
{% endblock %}

{% block content %}
<div x-data="{ sidebarExpanded: window.innerWidth >= 768, filterType: 'all' }" class="min-h-screen chat-bg-gradient flex relative">
    <!-- Overlay pour mobile -->
    <div 
        x-show="sidebarExpanded && window.innerWidth < 768"
        @click="sidebarExpanded = false"
        x-transition:enter="transition-opacity ease-linear duration-300"
        x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100"
        x-transition:leave="transition-opacity ease-linear duration-300"
        x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0"
        class="fixed inset-0 bg-black/50 z-40 md:hidden"
        style="display: none;"
    ></div>
    
    <!-- Sidebar - Liste des conversations et groupes (m√™me que /chat/) -->
    <aside 
        :class="sidebarExpanded ? 'sidebar-expanded' : 'sidebar-minimized'"
        class="h-screen bg-white/10 backdrop-blur-xl border-r border-white/20 transition-all duration-300 z-50 md:z-auto flex flex-col overflow-hidden"
    >
        <!-- Header Sidebar -->
        <div class="p-4 border-b border-white/20 flex-shrink-0">
            <div class="flex items-center justify-between mb-4" x-show="sidebarExpanded">
                <h2 class="text-white text-xl font-bold">Messages</h2>
                <button 
                    @click="sidebarExpanded = false"
                    class="text-white hover:bg-white/20 p-2 rounded-lg transition-colors"
                    title="R√©duire"
                >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                    </svg>
                </button>
            </div>
            
            <!-- Bouton pour d√©velopper (quand minimis√©e) -->
            <div x-show="!sidebarExpanded" class="flex justify-center">
                <button 
                    @click="sidebarExpanded = true"
                    class="text-white hover:bg-white/20 p-2 rounded-lg transition-colors"
                    title="D√©velopper"
                >
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                    </svg>
                </button>
            </div>
            
            <!-- Recherche (seulement quand d√©velopp√©e) -->
            <div class="relative" x-show="sidebarExpanded" x-transition>
                <input 
                    type="text" 
                    placeholder="Rechercher..."
                    class="w-full px-4 py-2 pl-10 rounded-xl bg-white/20 border border-white/30 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50 focus:border-white/50"
                >
                <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-white/60" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
            </div>
            
            <!-- Filtres (seulement quand d√©velopp√©e) -->
            <div class="mt-3 flex space-x-2" x-show="sidebarExpanded" x-transition>
                <button 
                    @click="filterType = 'all'"
                    :class="filterType === 'all' ? 'bg-white/30 text-white' : 'bg-white/10 text-white/70 hover:bg-white/20'"
                    class="flex-1 px-3 py-1.5 rounded-lg text-xs font-semibold transition-all duration-200"
                >
                    Tous
                </button>
                <button 
                    @click="filterType = 'conversations'"
                    :class="filterType === 'conversations' ? 'bg-white/30 text-white' : 'bg-white/10 text-white/70 hover:bg-white/20'"
                    class="flex-1 px-3 py-1.5 rounded-lg text-xs font-semibold transition-all duration-200"
                >
                    Chats
                </button>
                <button 
                    @click="filterType = 'groups'"
                    :class="filterType === 'groups' ? 'bg-white/30 text-white' : 'bg-white/10 text-white/70 hover:bg-white/20'"
                    class="flex-1 px-3 py-1.5 rounded-lg text-xs font-semibold transition-all duration-200"
                >
                    Groupes
                </button>
            </div>
        </div>
        
        <!-- Liste des conversations et groupes -->
        <div class="flex-1 overflow-y-auto">
            {% if all_items %}
                <div class="p-2 space-y-1">
                    {% for item in all_items %}
                        {% if item.type == 'conversation' and item.other_user %}
                            <div x-show="filterType === 'all' || filterType === 'conversations'">
                            <!-- Conversation priv√©e -->
                            <a 
                                href="{% url 'chat:detail' item.conversation.id %}" 
                                class="block glass-card rounded-xl p-3 hover:bg-white/20 transition-all duration-200 group relative {% if item.conversation.id == conversation.id %}bg-white/25{% endif %}"
                                :title="sidebarExpanded ? '' : '{{ item.other_user.username }}'"
                            >
                                <div class="flex items-center space-x-3">
                                    <!-- Avatar avec statut -->
                                    <div class="relative flex-shrink-0">
                                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center overflow-hidden ring-2 ring-white/30">
                                            {% if item.other_user.avatar %}
                                                <img src="{{ item.other_user.avatar.url }}" alt="{{ item.other_user.username }}" class="w-full h-full object-cover">
                                            {% else %}
                                                <span class="text-white text-lg font-bold">{{ item.other_user.username|first|upper }}</span>
                                            {% endif %}
                                        </div>
                                        <!-- Pastille de statut -->
                                        <span class="absolute bottom-0 right-0 w-3.5 h-3.5 bg-green-400 border-2 border-white/20 rounded-full"></span>
                                    </div>
                                    
                                    <!-- Informations (cach√©es quand minimis√©e) -->
                                    <div class="flex-1 min-w-0" x-show="sidebarExpanded" x-transition>
                                        <div class="flex items-center justify-between mb-1">
                                            <p class="text-white font-semibold text-sm truncate">{{ item.other_user.username }}</p>
                                            {% if item.last_message %}
                                                <span class="text-white/60 text-xs ml-2 flex-shrink-0">
                                                    {{ item.last_message.created_at|format_chat_time }}
                                                </span>
                                            {% endif %}
                                        </div>
                                        <div class="flex items-center justify-between">
                                            {% if item.last_message %}
                                                <p class="text-white/80 text-sm truncate">{{ item.last_message.content|truncatewords:8 }}</p>
                                            {% else %}
                                                <p class="text-white/60 text-sm italic">Aucun message</p>
                                            {% endif %}
                                            {% if item.unread_count > 0 %}
                                                <span class="ml-2 flex-shrink-0 w-5 h-5 rounded-full bg-blue-500 flex items-center justify-center">
                                                    <span class="text-white text-xs font-bold">{{ item.unread_count }}</span>
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </a>
                            </div>
                        {% elif item.type == 'group' %}
                            <div x-show="filterType === 'all' || filterType === 'groups'">
                            <!-- Groupe -->
                            <a 
                                href="{% url 'forum:group_detail' item.group.id %}" 
                                class="block glass-card rounded-xl p-3 hover:bg-white/20 transition-all duration-200 group relative"
                                :title="sidebarExpanded ? '' : '{{ item.group.name }}'"
                            >
                                <div class="flex items-center space-x-3">
                                    <!-- Avatar du groupe -->
                                    <div class="relative flex-shrink-0">
                                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-purple-400 to-pink-500 flex items-center justify-center overflow-hidden ring-2 ring-white/30">
                                            {% if item.group.image %}
                                                <img src="{{ item.group.image.url }}" alt="{{ item.group.name }}" class="w-full h-full object-cover">
                                            {% else %}
                                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                                                </svg>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <!-- Informations (cach√©es quand minimis√©e) -->
                                    <div class="flex-1 min-w-0" x-show="sidebarExpanded" x-transition>
                                        <div class="flex items-center justify-between mb-1">
                                            <p class="text-white font-semibold text-sm truncate">{{ item.group.name }}</p>
                                            {% if item.last_message %}
                                                <span class="text-white/60 text-xs ml-2 flex-shrink-0">
                                                    {{ item.last_message.created_at|format_chat_time }}
                                                </span>
                                            {% endif %}
                                        </div>
                                        <div class="flex items-center justify-between">
                                            {% if item.last_message %}
                                                <p class="text-white/80 text-sm truncate">
                                                    <span class="font-medium">{{ item.last_message.sender.username }}:</span> {{ item.last_message.content|truncatewords:6 }}
                                                </p>
                                            {% else %}
                                                <p class="text-white/60 text-sm italic">Aucun message</p>
                                            {% endif %}
                                            {% if item.unread_count > 0 %}
                                                <span class="ml-2 flex-shrink-0 w-5 h-5 rounded-full bg-blue-500 flex items-center justify-center">
                                                    <span class="text-white text-xs font-bold">{{ item.unread_count }}</span>
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </a>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            {% else %}
                <div class="p-8 text-center" x-show="sidebarExpanded" x-transition>
                    <svg class="w-16 h-16 text-white/40 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 8.511c.884.284 1.5 1.128 1.5 2.097v4.286c0 1.136-.847 2.1-1.98 2.193-.34.027-.68.052-1.02.072v3.091l-3-3c-1.354 0-2.694-.055-4.02-.163a2.115 2.115 0 01-.825-.242m9.345-8.334a2.126 2.126 0 00-.476-.095 48.64 48.64 0 00-8.048 0c-1.131.094-1.976 1.057-1.976 2.192v4.286c0 .837.46 1.58 1.155 1.951m9.345-8.334V6.637c0-1.621-1.152-3.026-2.76-3.235A48.455 48.455 0 0011.25 3c-2.115 0-4.198.137-6.24.402-1.608.209-2.76 1.614-2.76 3.235v6.226c0 1.621 1.152 3.026 2.76 3.235.577.075 1.157.14 1.74.194V21l4.155-4.155" />
                    </svg>
                    <p class="text-white/80 font-semibold mb-2">Aucune conversation</p>
                    <p class="text-white/60 text-sm mb-4">Commencez √† discuter avec vos contacts</p>
                    <a href="{% url 'chat:contacts' %}" class="inline-flex items-center space-x-2 px-6 py-3 rounded-full bg-white/20 hover:bg-white/30 text-white font-semibold transition-all duration-200">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                        </svg>
                        <span>Nouvelle conversation</span>
                    </a>
                </div>
            {% endif %}
        </div>
        
        <!-- Bouton Nouveau (en bas de la sidebar) -->
        <div class="p-4 border-t border-white/20 flex-shrink-0" x-show="sidebarExpanded" x-transition>
            <a 
                href="{% url 'chat:contacts' %}" 
                class="w-full flex items-center justify-center space-x-2 px-4 py-3 rounded-xl bg-white/20 hover:bg-white/30 text-white font-semibold transition-all duration-200"
            >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                </svg>
                <span>Nouveau message</span>
            </a>
        </div>
        
        <!-- Bouton Nouveau (minimis√©) -->
        <div class="p-4 border-t border-white/20 flex-shrink-0 flex justify-center" x-show="!sidebarExpanded" x-transition>
            <a 
                href="{% url 'chat:contacts' %}" 
                class="w-12 h-12 rounded-full bg-white/20 hover:bg-white/30 text-white transition-all duration-200 flex items-center justify-center"
                title="Nouveau message"
            >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                </svg>
            </a>
        </div>
    </aside>
    
    <!-- Zone de chat principale -->
    <main class="flex-1 flex flex-col">
        <!-- Header de conversation - Tab bar plus fonc√©e -->
        <header class="glass-card tab-bar border-b border-white/20 p-2 md:p-4 flex items-center justify-between gap-2 flex-shrink-0">
            <div class="flex items-center space-x-2 md:space-x-3 min-w-0 flex-1">
                <!-- Bouton retour au feed (mobile) -->
                <a 
                    href="{% url 'forum:feed' %}"
                    class="md:hidden text-white hover:bg-white/20 p-1.5 rounded-lg transition-colors flex-shrink-0"
                    title="Retour au feed"
                >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
                    </svg>
                </a>
                
                <!-- Bouton menu mobile -->
                <button 
                    @click="sidebarExpanded = !sidebarExpanded"
                    class="md:hidden text-white hover:bg-white/20 p-1.5 rounded-lg transition-colors flex-shrink-0"
                    title="Menu"
                >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                    </svg>
                </button>
                
                <!-- Avatar avec statut -->
                <a href="{% url 'users:profile' other_user.username %}" class="relative flex-shrink-0 hover:opacity-80 transition-opacity group">
                    <div class="w-10 h-10 md:w-12 md:h-12 rounded-full bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center overflow-hidden ring-2 ring-white/30 group-hover:ring-white/50 transition-all">
                {% if other_user.avatar %}
                    <img src="{{ other_user.avatar.url }}" alt="{{ other_user.username }}" class="w-full h-full object-cover">
                {% else %}
                            <span class="text-white text-sm md:text-lg font-bold">{{ other_user.username|first|upper }}</span>
                {% endif %}
            </div>
                    <span class="absolute bottom-0 right-0 w-3 h-3 md:w-3.5 md:h-3.5 bg-green-400 border-2 border-white/20 rounded-full"></span>
                </a>
                
                <!-- Nom et statut -->
                <div class="min-w-0 flex-1 flex flex-col leading-tight">
                    <a href="{% url 'users:profile' other_user.username %}" class="block hover:opacity-80 transition-opacity w-full">
                        <span class="text-white font-semibold text-sm md:text-base truncate block mb-0.5">{{ other_user.username }}</span>
                        <span class="text-white/70 text-xs flex items-center gap-1.5">
                            <span class="w-2 h-2 bg-green-400 rounded-full flex-shrink-0"></span>
                            <span class="truncate">En ligne</span>
                        </span>
                    </a>
            </div>
        </div>
    
            <!-- Actions (appel vocal, retour au feed desktop, options) -->
            <div class="flex items-center space-x-1 md:space-x-2 flex-shrink-0">
                <!-- Bouton retour au feed (desktop) -->
                <a 
                    href="{% url 'forum:feed' %}"
                    class="hidden md:flex text-white hover:bg-white/20 p-2 rounded-lg transition-colors"
                    title="Retour au feed"
                >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
                    </svg>
                </a>
                
                <!-- Bouton appel vocal -->
                <button 
                    id="call-button"
                    onclick="startCall(); return false;"
                    class="text-white hover:bg-white/20 p-1.5 md:p-2 rounded-lg transition-colors cursor-pointer"
                    title="Appeler"
                >
                    <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 002.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 01-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 00-1.091-.852H4.5A2.25 2.25 0 002.25 4.5v2.25z" />
                    </svg>
                </button>
                
                <button class="text-white hover:bg-white/20 p-1.5 md:p-2 rounded-lg transition-colors" title="Options">
                    <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                    </svg>
                </button>
    </div>
        </header>
    
        <!-- Zone des messages -->
        <div class="chat-container">
        <div class="messages-container" id="messages-container">
            {% for message in messages %}
                    <div class="message-bubble {% if message.sender == user %}message-sent{% else %}message-received{% endif %}">
                        <div>
                    {% if message.sender != user %}
                                <div class="flex items-center space-x-2 mb-1">
                                    <a href="{% url 'users:profile' message.sender.username %}" class="flex items-center space-x-2 hover:opacity-80 transition-opacity group">
                                        <div class="w-6 h-6 rounded-full bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center overflow-hidden flex-shrink-0 ring-1 ring-white/30">
                                            {% if message.sender.avatar %}
                                                <img src="{{ message.sender.avatar.url }}" alt="{{ message.sender.username }}" class="w-full h-full object-cover">
                                            {% else %}
                                                <span class="text-white text-xs font-bold">{{ message.sender.username|first|upper }}</span>
                    {% endif %}
                                        </div>
                                        <p class="text-xs font-semibold opacity-90">{{ message.sender.username }}</p>
                                    </a>
                                </div>
                    {% endif %}
                            {% if message.content %}
                                <p class="text-sm leading-relaxed whitespace-pre-wrap">{{ message.content }}</p>
                    {% endif %}
                    {% if message.image %}
                                <img src="{{ message.image.url }}" alt="Message image" class="mt-2 rounded-xl max-w-full shadow-md cursor-pointer" onclick="openImageModal('{{ message.image.url }}')">
                    {% endif %}
                            {% if message.video %}
                                <video src="{{ message.video.url }}" controls class="mt-2 rounded-xl max-w-full max-h-64 shadow-md">
                                    Votre navigateur ne supporte pas la lecture de vid√©os.
                                </video>
                        {% endif %}
                            {% if message.audio %}
                                <div class="mt-2 p-2 md:p-3 rounded-xl bg-white/30 backdrop-blur-sm">
                                    <audio src="{{ message.audio.url }}" controls class="w-full">
                                        Votre navigateur ne supporte pas la lecture audio.
                                    </audio>
                                </div>
                            {% endif %}
                            {% if message.file %}
                                <div class="mt-2 p-2 md:p-3 rounded-xl bg-white/30 backdrop-blur-sm flex items-center space-x-2 md:space-x-3 gap-2 border border-white/20">
                                    <div class="flex-shrink-0">
                                        {% if message.file_name %}
                                            {% if ".pdf" in message.file_name|lower %}
                                                <svg class="w-6 h-6 md:w-8 md:h-8 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd" />
                                                </svg>
                                            {% elif ".doc" in message.file_name|lower %}
                                                <svg class="w-6 h-6 md:w-8 md:h-8 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd" />
                                                </svg>
                                            {% elif ".xls" in message.file_name|lower %}
                                                <svg class="w-6 h-6 md:w-8 md:h-8 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd" />
                                                </svg>
                                            {% else %}
                                                <svg class="w-6 h-6 md:w-8 md:h-8 text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd" />
                                                </svg>
                                            {% endif %}
                                        {% else %}
                                            <svg class="w-6 h-6 md:w-8 md:h-8 text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd" />
                                            </svg>
                                        {% endif %}
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-xs md:text-sm font-semibold opacity-90 truncate">{{ message.file_name|default:"Fichier" }}</p>
                                        <p class="text-xs opacity-75">Fichier joint</p>
                                    </div>
                                    <a href="{{ message.file.url }}" download class="flex-shrink-0 text-blue-500 hover:text-blue-700 transition-colors" title="T√©l√©charger">
                                        <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                                        </svg>
                                    </a>
                                </div>
                            {% endif %}
                            <div class="flex items-center {% if message.sender == user %}justify-end{% else %}justify-start{% endif %} mt-1.5 space-x-1">
                                <span class="text-xs opacity-70">
                                    {{ message.created_at|format_chat_time }}
                                </span>
                                {% if message.sender == user %}
                                    {% if message.read_at %}
                                        <svg class="w-4 h-4 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" />
                                        </svg>
                                    {% else %}
                                        <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                                        </svg>
                    {% endif %}
                        {% endif %}
                            </div>
                        </div>
                </div>
            {% empty %}
                    <div class="text-center text-white/60 mt-8">
                    <p>Aucun message. Commencez la conversation !</p>
                </div>
            {% endfor %}
                
            <!-- Typing indicator -->
            <div id="typing-indicator" class="typing-indicator">
                    <div class="message-received">
                        <div>
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                            </div>
                    </div>
                </div>
            </div>
        </div>
        
            <!-- Input de message - Tab bar plus fonc√©e -->
            <div class="glass-card tab-bar border-t border-white/20 p-2 md:p-4 relative flex-shrink-0" x-data="{ 
                emojiPickerOpen: false, 
                selectedFile: null, 
                fileInput: null,
                emojis: ['üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'ü§£', 'üòÇ', 'üôÇ', 'üôÉ', 'üòâ', 'üòä', 'üòá', 'ü•∞', 'üòç', 'ü§©', 'üòò', 'üòó', 'üòö', 'üòô', 'üòã', 'üòõ', 'üòú', 'ü§™', 'üòù', 'ü§ë', 'ü§ó', 'ü§≠', 'ü§´', 'ü§î', 'ü§ê', 'ü§®', 'üòê', 'üòë', 'üò∂', 'üòè', 'üòí', 'üôÑ', 'üò¨', 'ü§•', 'üòå', 'üòî', 'üò™', 'ü§§', 'üò¥', 'üò∑', 'ü§í', 'ü§ï', 'ü§¢', 'ü§Æ', 'ü§ß', 'ü•µ', 'ü•∂', 'üò∂‚Äçüå´Ô∏è', 'üòµ', 'üòµ‚Äçüí´', 'ü§Ø', 'ü§†', 'ü•≥', 'üòé', 'ü§ì', 'üßê', 'üòï', 'üòü', 'üôÅ', 'üòÆ', 'üòØ', 'üò≤', 'üò≥', 'ü•∫', 'üò¶', 'üòß', 'üò®', 'üò∞', 'üò•', 'üò¢', 'üò≠', 'üò±', 'üòñ', 'üò£', 'üòû', 'üòì', 'üò©', 'üò´', 'ü•±', 'üò§', 'üò°', 'üò†', 'ü§¨', 'üòà', 'üëø', 'üíÄ', '‚ò†Ô∏è', 'üí©', 'ü§°', 'üëπ', 'üë∫', 'üëª', 'üëΩ', 'üëæ', 'ü§ñ', 'üò∫', 'üò∏', 'üòπ', 'üòª', 'üòº', 'üòΩ', 'üôÄ', 'üòø', 'üòæ', '‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§', 'ü§ç', 'ü§é', 'üíî', '‚ù£Ô∏è', 'üíï', 'üíû', 'üíì', 'üíó', 'üíñ', 'üíò', 'üíù', 'üíü', '‚òÆÔ∏è', '‚úùÔ∏è', '‚ò™Ô∏è', 'üïâÔ∏è', '‚ò∏Ô∏è', '‚ú°Ô∏è', 'üîØ', 'üïé', '‚òØÔ∏è', '‚ò¶Ô∏è', 'üõê', '‚õé', '‚ôà', '‚ôâ', '‚ôä', '‚ôã', '‚ôå', '‚ôç', '‚ôé', '‚ôè', '‚ôê', '‚ôë', '‚ôí', '‚ôì', 'üÜî', '‚öõÔ∏è', 'üâë', '‚ò¢Ô∏è', '‚ò£Ô∏è', 'üì¥', 'üì≥', 'üà∂', 'üàö', 'üà∏', 'üà∫', 'üà∑Ô∏è', '‚ú¥Ô∏è', 'üÜö', 'üíÆ', 'üâê', '„äôÔ∏è', '„äóÔ∏è', 'üà¥', 'üàµ', 'üàπ', 'üà≤', 'üÖ∞Ô∏è', 'üÖ±Ô∏è', 'üÜé', 'üÜë', 'üÖæÔ∏è', 'üÜò', '‚ùå', '‚≠ï', 'üõë', '‚õî', 'üìõ', 'üö´', 'üíØ', 'üí¢', '‚ô®Ô∏è', 'üö∑', 'üöØ', 'üö≥', 'üö±', 'üîû', 'üìµ', 'üö≠', '‚ùó', '‚ùï', '‚ùì', '‚ùî', '‚ÄºÔ∏è', '‚ÅâÔ∏è', 'üîÖ', 'üîÜ', '„ÄΩÔ∏è', '‚ö†Ô∏è', 'üö∏', 'üî±', '‚öúÔ∏è', 'üî∞', '‚ôªÔ∏è', '‚úÖ', 'üàØ', 'üíπ', '‚ùáÔ∏è', '‚ú≥Ô∏è', '‚ùé', 'üåê', 'üí†', '‚ìÇÔ∏è', 'üåÄ', 'üí§', 'üèß', 'üöæ', '‚ôø', 'üÖøÔ∏è', 'üà≥', 'üàÇÔ∏è', 'üõÇ', 'üõÉ', 'üõÑ', 'üõÖ', 'üöπ', 'üö∫', 'üöº', 'üöª', 'üöÆ', 'üé¶', 'üì∂', 'üàÅ', 'üî£', '‚ÑπÔ∏è', 'üî§', 'üî°', 'üî†', 'üÜñ', 'üÜó', 'üÜô', 'üÜí', 'üÜï', 'üÜì', '0Ô∏è‚É£', '1Ô∏è‚É£', '2Ô∏è‚É£', '3Ô∏è‚É£', '4Ô∏è‚É£', '5Ô∏è‚É£', '6Ô∏è‚É£', '7Ô∏è‚É£', '8Ô∏è‚É£', '9Ô∏è‚É£', 'üîü', 'üî¢', '#Ô∏è‚É£', '*Ô∏è‚É£', '‚ñ∂Ô∏è', '‚è∏Ô∏è', '‚èØÔ∏è', '‚èπÔ∏è', '‚è∫Ô∏è', '‚è≠Ô∏è', '‚èÆÔ∏è', '‚è©', '‚è™', '‚è´', '‚è¨', '‚óÄÔ∏è', 'üîº', 'üîΩ', '‚û°Ô∏è', '‚¨ÖÔ∏è', '‚¨ÜÔ∏è', '‚¨áÔ∏è', '‚ÜóÔ∏è', '‚ÜòÔ∏è', '‚ÜôÔ∏è', '‚ÜñÔ∏è', '‚ÜïÔ∏è', '‚ÜîÔ∏è', '‚Ü™Ô∏è', '‚Ü©Ô∏è', '‚§¥Ô∏è', '‚§µÔ∏è', 'üîÄ', 'üîÅ', 'üîÇ', 'üîÑ', 'üîÉ', 'üéµ', 'üé∂', '‚ûï', '‚ûñ', '‚ûó', '‚úñÔ∏è', 'üí≤', 'üí±', '‚Ñ¢Ô∏è', '¬©Ô∏è', '¬ÆÔ∏è', '„Ä∞Ô∏è', '‚û∞', '‚ûø', 'üîö', 'üîô', 'üîõ', 'üîú', 'üîù', '‚úîÔ∏è', '‚òëÔ∏è', 'üîò', '‚ö™', '‚ö´', 'üî¥', 'üîµ', 'üî∫', 'üîª', 'üî∏', 'üîπ', 'üî∂', 'üî∑', 'üî≥', 'üî≤', '‚ñ™Ô∏è', '‚ñ´Ô∏è', '‚óæ', '‚óΩ', '‚óºÔ∏è', '‚óªÔ∏è', 'üü•', 'üüß', 'üü®', 'üü©', 'üü¶', 'üü™', '‚¨õ', '‚¨ú', 'üü´', 'üîà', 'üîá', 'üîâ', 'üîä', 'üîî', 'üîï', 'üì£', 'üì¢', 'üëÅÔ∏è‚Äçüó®Ô∏è', 'üí¨', 'üí≠', 'üóØÔ∏è', '‚ô†Ô∏è', '‚ô£Ô∏è', '‚ô•Ô∏è', '‚ô¶Ô∏è', 'üÉè', 'üé¥', 'üÄÑ', 'üïê', 'üïë', 'üïí', 'üïì', 'üïî', 'üïï', 'üïñ', 'üïó', 'üïò', 'üïô', 'üïö', 'üïõ', 'üïú', 'üïù', 'üïû', 'üïü', 'üï†', 'üï°', 'üï¢', 'üï£', 'üï§', 'üï•', 'üï¶', 'üïß'],
                insertEmoji(emoji) {
                    const input = document.getElementById('chat-message-input');
                    const cursorPos = input.selectionStart || input.value.length;
                    input.value = input.value.slice(0, cursorPos) + emoji + input.value.slice(cursorPos);
                    input.focus();
                    input.setSelectionRange(cursorPos + emoji.length, cursorPos + emoji.length);
                },
                formatFileSize(bytes) {
                    if (!bytes) return '';
                    if (bytes < 1024) return bytes + ' B';
                    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
                    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
                }
            }">
                <!-- Aper√ßu du fichier s√©lectionn√© -->
                <div x-show="selectedFile" class="mb-2 md:mb-3 p-2 md:p-3 rounded-xl bg-white/20 flex items-center justify-between gap-2" x-transition>
                    <div class="flex items-center space-x-2 md:space-x-3 flex-1 min-w-0">
                        <svg class="w-6 h-6 md:w-8 md:h-8 text-white/80 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd" />
                        </svg>
                        <div class="flex-1 min-w-0">
                            <p class="text-xs md:text-sm font-semibold text-white truncate" x-text="selectedFile ? selectedFile.name : 'Fichier'"></p>
                            <p class="text-xs text-white/70 truncate" x-text="selectedFile ? formatFileSize(selectedFile.size) : ''"></p>
                        </div>
                    </div>
                    <button @click="selectedFile = null; if(fileInput) fileInput.value = ''" class="text-white/80 hover:text-white transition-colors flex-shrink-0">
                        <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                
                <!-- S√©lecteur d'emojis -->
                <div x-show="emojiPickerOpen" @click.away="emojiPickerOpen = false" class="absolute bottom-full left-2 md:left-4 mb-2 glass-card rounded-2xl p-2 md:p-4 w-[calc(100vw-1rem)] md:w-80 max-h-64 overflow-y-auto z-50 shadow-2xl" x-transition style="display: none;">
                    <div class="grid grid-cols-8 gap-1 md:gap-2">
                        <template x-for="emoji in emojis" :key="emoji">
                            <button 
                                @click="insertEmoji(emoji); emojiPickerOpen = false"
                                class="text-2xl hover:bg-white/20 rounded-lg p-2 transition-colors hover:scale-110"
                                :title="emoji"
                                x-text="emoji"
                            ></button>
                        </template>
                    </div>
                </div>
                
                <form id="chat-form" class="flex items-end gap-1.5 md:gap-2.5 flex-wrap" enctype="multipart/form-data">
                {% csrf_token %}
                    <input type="file" id="file-input" name="file" accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.xls,.xlsx,.txt,.zip,.rar" class="hidden" @change="selectedFile = $event.target.files[0]">
                    <input type="file" id="video-input" name="video" accept="video/*" class="hidden" @change="selectedFile = $event.target.files[0]">
                    <input type="file" id="audio-input" name="audio" accept="audio/*" class="hidden" @change="selectedFile = $event.target.files[0]">
                    <input type="hidden" id="file-name-input" name="file_name">
                    
                    <!-- Boutons d'action (groupe compact sur mobile) -->
                    <div class="flex items-center gap-1 md:gap-1.5 flex-shrink-0">
                        <!-- Bouton emoji -->
                        <button 
                            type="button"
                            @click="emojiPickerOpen = !emojiPickerOpen"
                            class="flex-shrink-0 w-8 h-8 md:w-10 md:h-10 rounded-full bg-white/20 hover:bg-white/30 text-white transition-colors flex items-center justify-center"
                            title="Emoji"
                        >
                            <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.182 15.182a4.5 4.5 0 01-6.364 0M21 12a9 9 0 11-18 0 9 9 0 0118 0zM9.75 9.75c0 .414-.168.75-.375.75S9 10.164 9 9.75 9.168 9 9.375 9s.375.336.375.75zm-.375 0h.008v.015h-.008V9.75zm5.625 0c0 .414-.168.75-.375.75s-.375-.336-.375-.75.168-.75.375-.75.375.336.375.75zm-.375 0h.008v.015h-.008V9.75z" />
                            </svg>
                        </button>
                        
                        <!-- Bouton vid√©o -->
                        <button 
                            type="button"
                            @click="document.getElementById('video-input').click(); fileInput = document.getElementById('video-input')"
                            class="flex-shrink-0 w-8 h-8 md:w-10 md:h-10 rounded-full bg-white/20 hover:bg-white/30 text-white transition-colors flex items-center justify-center"
                            title="Vid√©o"
                        >
                            <svg class="w-3.5 h-3.5 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                            </svg>
                        </button>
                        
                        <!-- Bouton audio -->
                        <button 
                            type="button"
                            @click="document.getElementById('audio-input').click(); fileInput = document.getElementById('audio-input')"
                            class="flex-shrink-0 w-8 h-8 md:w-10 md:h-10 rounded-full bg-white/20 hover:bg-white/30 text-white transition-colors flex items-center justify-center"
                            title="Audio"
                        >
                            <svg class="w-3.5 h-3.5 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
                            </svg>
                        </button>
                        
                        <!-- Bouton pi√®ce jointe -->
                        <button 
                            type="button"
                            @click="document.getElementById('file-input').click(); fileInput = document.getElementById('file-input')"
                            class="flex-shrink-0 w-8 h-8 md:w-10 md:h-10 rounded-full bg-white/20 hover:bg-white/30 text-white transition-colors flex items-center justify-center"
                            title="Pi√®ce jointe"
                        >
                            <svg class="w-3.5 h-3.5 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M18.375 12.739l-7.693 7.693a4.5 4.5 0 01-6.364-6.364l10.94-10.94A3 3 0 1119.5 7.372L8.552 18.32m.009-.01l-.01.01m5.699-9.941l-1.06-1.06a2.548 2.548 0 00-3.603 3.603l1.06 1.06" />
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Input texte multiligne -->
                    <textarea 
                    id="chat-message-input"
                        placeholder="√âcrire un message‚Ä¶"
                        rows="1"
                        class="flex-1 min-w-0 px-2.5 md:px-4 py-2 md:py-3 rounded-2xl bg-white/20 border border-white/30 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50 focus:border-white/50 transition-all text-sm md:text-base resize-none overflow-hidden max-h-32"
                    autocomplete="off"
                        style="min-height: 2.5rem; max-height: 8rem; font-size: 16px;"
                    ></textarea>
                    
                    <!-- Bouton envoi -->
                <button 
                    type="submit"
                        class="flex-shrink-0 w-8 h-8 md:w-10 md:h-10 rounded-full bg-blue-500 hover:bg-blue-600 text-white transition-all duration-200 flex items-center justify-center shadow-lg hover:shadow-xl"
                        title="Envoyer"
                >
                        <svg class="w-3.5 h-3.5 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
                        </svg>
                </button>
            </form>
        </div>
    </div>
    </main>
</div>

<script>
    const conversationId = {{ conversation.id }};
    const currentUserId = {{ user.id }};
    let typingTimeout;
    let isTyping = false;
    let pollingInterval = null;
    let lastMessageId = null;
    
    const messagesContainer = document.getElementById('messages-container');
    const typingIndicator = document.getElementById('typing-indicator');
    const messageInput = document.getElementById('chat-message-input');
    
    // Fonction pour obtenir le dernier message ID
    function updateLastMessageId() {
        const messages = messagesContainer?.querySelectorAll('[data-message-id]');
        if (messages && messages.length > 0) {
            const lastMessage = messages[messages.length - 1];
            const messageId = lastMessage.getAttribute('data-message-id');
            if (messageId && !messageId.toString().startsWith('temp_')) {
                lastMessageId = parseInt(messageId);
            }
        }
    }
    
    // Fonction de polling pour r√©cup√©rer les nouveaux messages
    async function pollNewMessages() {
        if (!conversationId) return;
        
        try {
            const url = `/chat/${conversationId}/new-messages/`;
            const params = lastMessageId ? `?last_message_id=${lastMessageId}` : '';
            
            const response = await fetch(url + params, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                
                if (data.messages && data.messages.length > 0) {
                    // Ajouter les nouveaux messages
                    data.messages.forEach(message => {
                        // V√©rifier si le message n'existe pas d√©j√†
                        if (!document.querySelector(`[data-message-id="${message.id}"]`)) {
                            const isOwnMessage = message.sender_id === currentUserId;
                            addMessageToDOM(message, isOwnMessage);
                            
                            // Si c'est un message re√ßu, marquer comme lu automatiquement
                            if (!isOwnMessage) {
                                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                                                document.cookie.match(/csrftoken=([^;]+)/)?.[1] || '';
                                fetch(`/chat/messages/${message.id}/read/`, {
                                    method: 'POST',
                                    headers: {
                                        'X-CSRFToken': csrfToken,
                                        'Content-Type': 'application/json',
                                    },
                                }).catch(err => {
                                    console.log('Could not mark message as read:', err);
                                });
                            }
                            
                            lastMessageId = Math.max(lastMessageId || 0, message.id);
                        }
                    });
                }
            }
        } catch (error) {
            console.error('Erreur lors du polling:', error);
        }
    }
    
    // D√©marrer le polling
    function startPolling() {
        // Arr√™ter le polling pr√©c√©dent si existant
        if (pollingInterval) {
            clearInterval(pollingInterval);
        }
        
        // Mettre √† jour le dernier message ID
        updateLastMessageId();
        
        // D√©marrer le polling toutes les 2 secondes
        pollingInterval = setInterval(pollNewMessages, 2000);
        
        console.log('Polling d√©marr√© pour la conversation', conversationId);
    }
    
    // Arr√™ter le polling
    function stopPolling() {
        if (pollingInterval) {
            clearInterval(pollingInterval);
            pollingInterval = null;
        }
    }
    
    // D√©marrer le polling au chargement
    startPolling();
    
    // Arr√™ter le polling quand la page est cach√©e
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            stopPolling();
        } else {
            startPolling();
        }
    });
    
    // Emp√™cher tout rechargement de page accidentel
    // Protection contre les erreurs qui pourraient causer des rechargements
    const originalReload = window.location.reload;
    window.location.reload = function() {
        console.warn('location.reload() appel√© - bloqu√© pour √©viter les rechargements');
        // Ne pas recharger - juste logger
        return;
    };
    
    // Protection contre les erreurs non g√©r√©es
    window.addEventListener('error', function(e) {
        console.error('Global error caught:', e.error, e.message, e.filename, e.lineno);
        // Ne pas recharger - juste logger
        e.preventDefault();
        return false;
    }, true);
    
    window.addEventListener('unhandledrejection', function(e) {
        console.error('Unhandled promise rejection:', e.reason);
        // Ne pas recharger - juste logger
        e.preventDefault();
    });
    
    // Fonction pour v√©rifier si l'utilisateur est pr√®s du bas
    function isNearBottom(container, threshold = 100) {
        return container.scrollHeight - container.scrollTop - container.clientHeight < threshold;
    }
    
    // Fonction pour scroller vers le bas seulement si l'utilisateur est d√©j√† pr√®s du bas
    function scrollToBottomIfNeeded(container) {
        if (isNearBottom(container)) {
            // Utiliser requestAnimationFrame pour un scroll fluide
            requestAnimationFrame(() => {
                container.scrollTop = container.scrollHeight;
            });
        }
    }
    
    // Scroll to bottom on load (une seule fois)
    setTimeout(() => {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }, 100);
    
    // Protection globale contre les erreurs non g√©r√©es qui pourraient causer des rechargements
    window.addEventListener('error', function(e) {
        console.error('Global error caught:', e.error);
        // Ne pas recharger - juste logger l'erreur
        e.preventDefault();
        return false;
    });
    
    window.addEventListener('unhandledrejection', function(e) {
        console.error('Unhandled promise rejection:', e.reason);
        // Ne pas recharger - juste logger l'erreur
        e.preventDefault();
    });
    
    // Fonction pour ajouter un message au DOM (r√©utilisable pour WebSocket et HTTP)
    function addMessageToDOM(message, isOwnMessage) {
        // V√©rifier si le message n'existe pas d√©j√†
        const existingMessage = document.querySelector(`[data-message-id="${message.id}"]`);
        if (existingMessage) {
            return; // Message d√©j√† affich√©
        }
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `message-bubble ${isOwnMessage ? 'message-sent' : 'message-received'}`;
        messageDiv.setAttribute('data-message-id', message.id);
        
        const time = new Date(message.created_at).toLocaleTimeString('fr-FR', { 
            hour: '2-digit', 
            minute: '2-digit' 
        });
        
        let content = '<div>';
        
        // Avatar et nom de l'exp√©diteur (seulement pour les messages re√ßus)
        if (!isOwnMessage && message.sender) {
            content += `
                <div class="flex items-center space-x-2 mb-1">
                    <a href="/auth/profile/${escapeHtml(message.sender)}/" class="flex items-center space-x-2 hover:opacity-80 transition-opacity group">
                        <div class="w-6 h-6 rounded-full bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center overflow-hidden flex-shrink-0 ring-1 ring-white/30">
                            ${message.sender_avatar ? `<img src="${escapeHtml(message.sender_avatar)}" alt="${escapeHtml(message.sender)}" class="w-full h-full object-cover">` : `<span class="text-white text-xs font-bold">${escapeHtml(message.sender).charAt(0).toUpperCase()}</span>`}
                        </div>
                        <p class="text-xs font-semibold opacity-90">${escapeHtml(message.sender)}</p>
                    </a>
                </div>
            `;
        }
        
        // Contenu du message
        if (message.content) {
            content += `<p class="text-sm leading-relaxed whitespace-pre-wrap">${escapeHtml(message.content)}</p>`;
        }
        
        // Image
        if (message.image) {
            content += `<img src="${escapeHtml(message.image)}" alt="Message image" class="mt-2 rounded-xl max-w-full shadow-md cursor-pointer" onclick="openImageModal('${escapeHtml(message.image)}')">`;
        }
        
        // Vid√©o
        if (message.video) {
            content += `<video src="${escapeHtml(message.video)}" controls class="mt-2 rounded-xl max-w-full max-h-64 shadow-md">Votre navigateur ne supporte pas la lecture de vid√©os.</video>`;
        }
        
        // Audio
        if (message.audio) {
            content += `<div class="mt-2 p-2 md:p-3 rounded-xl bg-white/30 backdrop-blur-sm"><audio src="${escapeHtml(message.audio)}" controls class="w-full">Votre navigateur ne supporte pas la lecture audio.</audio></div>`;
        }
        
        // Fichier
        if (message.file) {
            const fileName = message.file_name || 'Fichier';
            const fileExtension = fileName.split('.').pop().toLowerCase();
            let fileIcon = '';
            
            if (fileExtension === 'pdf') {
                fileIcon = '<svg class="w-6 h-6 md:w-8 md:h-8 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd" /></svg>';
            } else if (fileExtension.includes('doc')) {
                fileIcon = '<svg class="w-6 h-6 md:w-8 md:h-8 text-blue-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd" /></svg>';
            } else if (fileExtension.includes('xls')) {
                fileIcon = '<svg class="w-6 h-6 md:w-8 md:h-8 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd" /></svg>';
            } else {
                fileIcon = '<svg class="w-6 h-6 md:w-8 md:h-8 text-gray-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd" /></svg>';
            }
            
            content += `
                <div class="mt-2 p-2 md:p-3 rounded-xl bg-white/30 backdrop-blur-sm flex items-center space-x-2 md:space-x-3 gap-2 border border-white/20">
                    <div class="flex-shrink-0">${fileIcon}</div>
                    <div class="flex-1 min-w-0">
                        <p class="text-xs md:text-sm font-semibold opacity-90 truncate">${escapeHtml(fileName)}</p>
                        <p class="text-xs opacity-75">Fichier joint</p>
                    </div>
                    <a href="${escapeHtml(message.file)}" download class="flex-shrink-0 text-blue-500 hover:text-blue-700 transition-colors" title="T√©l√©charger">
                        <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                        </svg>
                    </a>
                </div>
            `;
        }
        
        // Timestamp et statut de lecture (doubles coches style WhatsApp)
        const isRead = message.read_at !== null && message.read_at !== undefined;
        let readStatusIcon = '';
        if (isOwnMessage) {
            if (isRead) {
                // Double coche bleue (message lu) - style WhatsApp
                readStatusIcon = '<svg class="w-4 h-4 text-blue-500" fill="currentColor" viewBox="0 0 16 16"><path d="M15.854 2.146a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L8.5 9.293l6.646-6.647a.5.5 0 0 1 .708 0z"/><path d="M15.854 1.146a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 0 1 .708-.708L8.5 8.293l6.646-6.647a.5.5 0 0 1 .708 0z"/></svg>';
            } else {
                // Double coche grise (message envoy√© mais pas lu) - style WhatsApp
                readStatusIcon = '<svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 16 16"><path d="M15.854 2.146a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L8.5 9.293l6.646-6.647a.5.5 0 0 1 .708 0z"/><path d="M15.854 1.146a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 0 1 .708-.708L8.5 8.293l6.646-6.647a.5.5 0 0 1 .708 0z"/></svg>';
            }
        }
        
        content += `
            <div class="flex items-center ${isOwnMessage ? 'justify-end' : 'justify-start'} mt-1.5 space-x-1">
                <span class="text-xs opacity-70">${time}</span>
                ${isOwnMessage ? `<span class="read-status-icon">${readStatusIcon}</span>` : ''}
            </div>
        </div>`;
        
        messageDiv.innerHTML = content;
        messagesContainer.insertBefore(messageDiv, typingIndicator);
        
        // Animation d'apparition
        requestAnimationFrame(() => {
            messageDiv.style.opacity = '0';
            messageDiv.style.transform = 'translateY(10px)';
            messageDiv.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
            requestAnimationFrame(() => {
                messageDiv.style.opacity = '1';
                messageDiv.style.transform = 'translateY(0)';
            });
        });
        
        // Scroller seulement si l'utilisateur est pr√®s du bas ou si c'est son propre message
        if (isOwnMessage || isNearBottom(messagesContainer)) {
            scrollToBottomIfNeeded(messagesContainer);
        }
    }
    
    // Auto-resize textarea
    function autoResizeTextarea(textarea) {
        textarea.style.height = 'auto';
        const newHeight = Math.min(textarea.scrollHeight, 128); // max 128px (max-h-32)
        textarea.style.height = newHeight + 'px';
    }
    
    // Initialiser la hauteur du textarea
    autoResizeTextarea(messageInput);
    
    // Handle typing indicator et auto-resize
    messageInput.addEventListener('input', function() {
        autoResizeTextarea(this);
        
        // Typing indicator d√©sactiv√© avec polling (peut √™tre r√©impl√©ment√© avec une API s√©par√©e si n√©cessaire)
    });
    
    // G√©rer Enter (envoyer) vs Shift+Enter (nouvelle ligne)
    messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            document.querySelector('#chat-form').dispatchEvent(new Event('submit'));
        }
    });
    
    document.querySelector('#chat-form').onsubmit = function(e) {
        e.preventDefault();
        const message = messageInput.value.trim();
        const fileInput = document.getElementById('file-input');
        const videoInput = document.getElementById('video-input');
        const audioInput = document.getElementById('audio-input');
        const selectedFile = fileInput.files[0] || videoInput.files[0] || audioInput.files[0];
        
        // R√©initialiser la hauteur du textarea
        messageInput.style.height = 'auto';
        
        // Si un fichier est s√©lectionn√©, envoyer via HTTP
        if (selectedFile) {
            const formData = new FormData();
            formData.append('content', message);
            
            // D√©tecter le type de fichier
            if (videoInput && videoInput.files[0]) {
                formData.append('video', videoInput.files[0]);
            } else if (audioInput && audioInput.files[0]) {
                formData.append('audio', audioInput.files[0]);
            } else if (fileInput && fileInput.files[0]) {
                formData.append('file', fileInput.files[0]);
                formData.append('file_name', fileInput.files[0].name);
            }
            
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
            
            // D√©sactiver le bouton d'envoi pendant l'envoi
            const submitButton = document.querySelector('#chat-form button[type="submit"]');
            const originalButtonContent = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = '<svg class="w-3.5 h-3.5 md:w-5 md:h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>';
            
            fetch(`{% url 'chat:send_message' conversation.id %}`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Ajouter le message directement au DOM sans rechargement
                    addMessageToDOM(data.message, true);
                    
                    // R√©initialiser le formulaire
                    messageInput.value = '';
                    messageInput.style.height = 'auto';
                    autoResizeTextarea(messageInput);
                    
                    // R√©initialiser les inputs de fichiers
                    if (fileInput) fileInput.value = '';
                    if (videoInput) videoInput.value = '';
                    if (audioInput) audioInput.value = '';
                    
                    // R√©initialiser Alpine.js selectedFile
                    if (window.Alpine && window.Alpine.store) {
                        window.Alpine.store('selectedFile', null);
                    }
                    
                    // R√©activer le bouton
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalButtonContent;
                } else if (data.error) {
                    alert('Erreur: ' + data.error);
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalButtonContent;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Erreur lors de l\'envoi du fichier');
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonContent;
            });
        } else if (message) {
            // Envoyer le message via HTTP (polling r√©cup√©rera automatiquement les nouveaux messages)
            const formData = new FormData();
            formData.append('content', message);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
            
            // Envoi optimiste : afficher le message imm√©diatement
            const tempMessageId = 'temp_' + Date.now();
            const optimisticMessage = {
                id: tempMessageId,
                content: message,
                sender: '{{ user.username|escapejs }}',
                sender_id: currentUserId,
                sender_avatar: {% if user.avatar %}'{{ user.avatar.url }}'{% else %}null{% endif %},
                created_at: new Date().toISOString(),
                image: null,
                video: null,
                audio: null,
                file: null,
                file_name: null,
                read_at: null,
            };
            addMessageToDOM(optimisticMessage, true);
            
            fetch(`{% url 'chat:send_message' conversation.id %}`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Supprimer le message optimiste
                    const tempMsg = document.querySelector(`[data-message-id="${tempMessageId}"]`);
                    if (tempMsg) {
                        tempMsg.remove();
                    }
                    // Le polling r√©cup√©rera le vrai message
                    messageInput.value = '';
                    messageInput.style.height = 'auto';
                    autoResizeTextarea(messageInput);
                } else if (data.error) {
                    // Supprimer le message optimiste en cas d'erreur
                    const tempMsg = document.querySelector(`[data-message-id="${tempMessageId}"]`);
                    if (tempMsg) {
                        tempMsg.remove();
                    }
                    alert('Erreur: ' + data.error);
                }
            })
            .catch(error => {
                // Supprimer le message optimiste en cas d'erreur
                const tempMsg = document.querySelector(`[data-message-id="${tempMessageId}"]`);
                if (tempMsg) {
                    tempMsg.remove();
                }
                console.error('Error:', error);
                alert('Erreur lors de l\'envoi du message');
            });
            
            // R√©initialiser les inputs de fichiers
            if (fileInput) fileInput.value = '';
            if (videoInput) videoInput.value = '';
            if (audioInput) audioInput.value = '';
            if (window.Alpine && window.Alpine.store) {
                window.Alpine.store('selectedFile', null);
            }
        }
    };
    
    // Escape HTML to prevent XSS
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Modal pour afficher les images en grand
    function openImageModal(imageUrl) {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4';
        modal.onclick = function(e) {
            if (e.target === modal) {
                document.body.removeChild(modal);
            }
        };
        modal.innerHTML = `
            <div class="relative max-w-4xl max-h-full">
                <button onclick="this.closest('.fixed').remove()" class="absolute top-4 right-4 text-white hover:text-gray-300 z-10 bg-black/50 rounded-full p-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
                <img src="${imageUrl}" alt="Image" class="max-w-full max-h-[90vh] rounded-lg shadow-2xl">
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    // WebRTC pour les appels vocaux
    let localStream = null;
    let remoteStream = null;
    let peerConnection = null;
    let callSocket = null;
    let isCallActive = false;
    let callSocketReady = false;
    let incomingCallData = null; // Stocker les donn√©es de l'appel entrant
    
    const servers = {
        iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' }
        ]
    };
    
    // Connexion WebSocket pour les appels
    function connectCallSocket() {
        if (callSocket && callSocket.readyState === WebSocket.OPEN) {
            callSocketReady = true;
            console.log('Call socket already connected');
            return;
        }
        
        // Fermer le socket existant s'il est en cours de fermeture ou ferm√©
        if (callSocket && (callSocket.readyState === WebSocket.CLOSING || callSocket.readyState === WebSocket.CLOSED)) {
            callSocket = null;
        }
        
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = wsProtocol + '//' + window.location.host + '/ws/call/' + conversationId + '/';
        console.log('Connecting to call socket:', wsUrl);
        
        callSocket = new WebSocket(wsUrl);
        
        callSocket.onopen = function() {
            console.log('Call socket connected successfully');
            callSocketReady = true;
        };
        
        callSocket.onmessage = function(e) {
            try {
                const data = JSON.parse(e.data);
                console.log('Call socket message received:', data.type, data);
                
                if (data.type === 'call-offer') {
                    console.log('Incoming call offer from:', data.from_username);
                    handleIncomingCall(data);
                } else if (data.type === 'call-answer') {
                    console.log('Call answer received from:', data.from_user_id);
                    handleCallAnswer(data);
                } else if (data.type === 'call-ice-candidate') {
                    console.log('ICE candidate received from:', data.from_user_id);
                    handleIceCandidate(data);
                } else if (data.type === 'call-end') {
                    console.log('Received call-end signal from user:', data.from_user_id);
                    // Toujours terminer l'appel si on re√ßoit un signal call-end
                    endCall();
                }
            } catch (error) {
                console.error('Error parsing call socket message:', error, e.data);
            }
        };
        
        callSocket.onerror = function(e) {
            console.error('Call socket error:', e);
            callSocketReady = false;
        };
        
        callSocket.onclose = function(e) {
            console.log('Call socket closed', e.code, e.reason);
            callSocketReady = false;
            // Reconnecter apr√®s 2 secondes si l'appel est actif ou si on est sur la page
            if (isCallActive || document.visibilityState === 'visible') {
                setTimeout(connectCallSocket, 2000);
            }
        };
    }
    
    // Fonction helper pour envoyer des messages via WebSocket
    function sendCallMessage(message) {
        if (callSocket && callSocket.readyState === WebSocket.OPEN) {
            try {
                const messageStr = JSON.stringify(message);
                console.log('Sending call message:', message.type);
                callSocket.send(messageStr);
                return true;
            } catch (error) {
                console.error('Error sending call message:', error);
                return false;
            }
        } else {
            const state = callSocket ? callSocket.readyState : 'null';
            console.warn('Call socket not ready (state:', state, '), attempting to reconnect...');
            if (!callSocket || callSocket.readyState === WebSocket.CLOSED || callSocket.readyState === WebSocket.CLOSING) {
                connectCallSocket();
            }
            return false;
        }
    }
    
    // D√©marrer un appel
    async function startCall() {
        console.log('startCall called, isCallActive:', isCallActive);
        
        if (isCallActive) {
            console.log('Call already active, ending it...');
            endCall();
            return;
        }
        
        // S'assurer que le socket est connect√©
        if (!callSocket || callSocket.readyState !== WebSocket.OPEN) {
            console.log('Call socket not ready, connecting...');
            connectCallSocket();
            // Attendre que le socket se connecte (max 5 secondes)
            let waitAttempts = 0;
            while ((!callSocket || callSocket.readyState !== WebSocket.OPEN) && waitAttempts < 25) {
                await new Promise(resolve => setTimeout(resolve, 200));
                waitAttempts++;
            }
            
            if (!callSocket || callSocket.readyState !== WebSocket.OPEN) {
                console.error('Socket connection timeout');
                alert('Erreur: Impossible de se connecter au serveur d\'appels. Veuillez r√©essayer.');
                return;
            }
        }
        
        try {
            console.log('Requesting user media...');
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
            console.log('User media obtained');
            
            peerConnection = new RTCPeerConnection(servers);
            console.log('Peer connection created');
            
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });
            
            peerConnection.ontrack = function(event) {
                console.log('Received remote track');
                remoteStream = event.streams[0];
                const remoteAudio = document.getElementById('remote-audio');
                if (remoteAudio) {
                    remoteAudio.srcObject = remoteStream;
                    remoteAudio.play().catch(e => console.error('Error playing remote audio:', e));
                }
            };
            
            peerConnection.onicecandidate = function(event) {
                if (event.candidate) {
                    console.log('ICE candidate generated');
                    sendCallMessage({
                        type: 'call-ice-candidate',
                        candidate: event.candidate
                    });
                }
            };
            
            peerConnection.oniceconnectionstatechange = function() {
                console.log('ICE connection state:', peerConnection.iceConnectionState);
                if (peerConnection.iceConnectionState === 'failed') {
                    console.error('ICE connection failed');
                }
            };
            
            console.log('Creating offer...');
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            console.log('Offer created and set as local description');
            
            // Attendre que le socket soit pr√™t avant d'envoyer l'offre
            let attempts = 0;
            let sent = false;
            while (!sent && attempts < 20) {
                if (callSocket && callSocket.readyState === WebSocket.OPEN) {
                    const message = {
                        type: 'call-offer',
                        offer: offer
                    };
                    console.log('Sending call offer:', message);
                    sent = sendCallMessage(message);
                    if (sent) {
                        console.log('Call offer sent successfully');
                        break;
                    } else {
                        console.log('Failed to send, retrying...');
                    }
                } else {
                    console.log('Waiting for socket to be ready, attempt', attempts + 1, 'State:', callSocket ? callSocket.readyState : 'null');
                    if (!callSocket || callSocket.readyState === WebSocket.CLOSED || callSocket.readyState === WebSocket.CLOSING) {
                        console.log('Socket closed, reconnecting...');
                        connectCallSocket();
                    }
                    await new Promise(resolve => setTimeout(resolve, 300));
                }
                attempts++;
            }
            
            if (!sent) {
                console.error('Failed to send call offer after', attempts, 'attempts');
                endCall();
                alert('Erreur: Impossible de se connecter au serveur d\'appels. Veuillez r√©essayer.');
                return;
            }
            
            isCallActive = true;
            showCallInterface(true);
            updateCallButton(true);
            console.log('Call started successfully');
        } catch (error) {
            console.error('Error starting call:', error);
            alert('Erreur lors du d√©marrage de l\'appel. V√©rifiez vos permissions de microphone.');
            endCall();
        }
    }
    
    // G√©rer un appel entrant
    async function handleIncomingCall(data) {
        console.log('Incoming call from:', data.from_username);
        
        if (isCallActive) {
            console.log('Already in a call, rejecting...');
            if (callSocket && callSocket.readyState === WebSocket.OPEN) {
                callSocket.send(JSON.stringify({ type: 'call-end' }));
            }
            return;
        }
        
        // Si un appel entrant est d√©j√† en attente, refuser le nouveau
        if (incomingCallData) {
            console.log('Another incoming call already pending, rejecting new one...');
            if (callSocket && callSocket.readyState === WebSocket.OPEN) {
                callSocket.send(JSON.stringify({ type: 'call-end' }));
            }
            return;
        }
        
        // Stocker les donn√©es de l'appel entrant
        incomingCallData = data;
        
        // Afficher l'interface d'appel entrant
        showIncomingCallInterface(data);
    }
    
    // Afficher l'interface d'appel entrant
    function showIncomingCallInterface(data) {
        // Supprimer l'interface existante si elle existe
        const existingInterface = document.getElementById('incoming-call-interface');
        if (existingInterface) {
            existingInterface.remove();
        }
        
        const incomingCallInterface = document.createElement('div');
        incomingCallInterface.id = 'incoming-call-interface';
        incomingCallInterface.className = 'fixed inset-0 bg-black/90 z-50 flex items-center justify-center';
        incomingCallInterface.innerHTML = `
            <div class="text-center text-white p-6 md:p-8">
                <div class="mb-8">
                    <div class="w-32 h-32 mx-auto rounded-full bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center mb-6 animate-pulse">
                        {% if other_user.avatar %}
                            <img src="{{ other_user.avatar.url }}" alt="${data.from_username}" class="w-full h-full rounded-full object-cover">
                        {% else %}
                            <span class="text-white text-4xl font-bold">${data.from_username.charAt(0).toUpperCase()}</span>
                        {% endif %}
                    </div>
                    <h3 class="text-3xl md:text-4xl font-bold mb-2">${data.from_username}</h3>
                    <p class="text-white/70 text-lg md:text-xl">Appel entrant...</p>
                </div>
                
                <div class="flex items-center justify-center gap-6 md:gap-8">
                    <!-- Bouton Refuser -->
                    <button id="reject-call-button" class="w-16 h-16 md:w-20 md:h-20 rounded-full bg-red-500 hover:bg-red-600 flex items-center justify-center transition-colors shadow-lg cursor-pointer transform hover:scale-110">
                        <svg class="w-8 h-8 md:w-10 md:h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                    
                    <!-- Bouton Accepter -->
                    <button id="accept-call-button" class="w-16 h-16 md:w-20 md:h-20 rounded-full bg-green-500 hover:bg-green-600 flex items-center justify-center transition-colors shadow-lg cursor-pointer transform hover:scale-110">
                        <svg class="w-8 h-8 md:w-10 md:h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                        </svg>
                    </button>
                </div>
                
                <p class="text-white/60 text-xs md:text-sm mt-6">Appuyez sur le bouton vert pour accepter ou rouge pour refuser</p>
            </div>
        `;
        
        document.body.appendChild(incomingCallInterface);
        
        // Ajouter les √©v√©nements aux boutons
        setTimeout(function() {
            const acceptButton = document.getElementById('accept-call-button');
            const rejectButton = document.getElementById('reject-call-button');
            
            if (acceptButton) {
                acceptButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Call accepted');
                    acceptIncomingCall();
                });
            }
            
            if (rejectButton) {
                rejectButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Call rejected');
                    rejectIncomingCall();
                });
            }
        }, 100);
    }
    
    // Accepter un appel entrant
    async function acceptIncomingCall() {
        if (!incomingCallData) {
            console.error('No incoming call data');
            return;
        }
        
        // Supprimer l'interface d'appel entrant
        const incomingCallInterface = document.getElementById('incoming-call-interface');
        if (incomingCallInterface) {
            incomingCallInterface.remove();
        }
        
        const data = incomingCallData;
        incomingCallData = null;
        
        try {
            console.log('Accepting call, requesting user media...');
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
            console.log('User media obtained');
            
            peerConnection = new RTCPeerConnection(servers);
            console.log('Peer connection created');
            
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });
            
            peerConnection.ontrack = function(event) {
                console.log('Received remote track');
                remoteStream = event.streams[0];
                const remoteAudio = document.getElementById('remote-audio');
                if (remoteAudio) {
                    remoteAudio.srcObject = remoteStream;
                    remoteAudio.play().catch(e => console.error('Error playing remote audio:', e));
                }
            };
            
            peerConnection.onicecandidate = function(event) {
                if (event.candidate) {
                    console.log('ICE candidate generated');
                    sendCallMessage({
                        type: 'call-ice-candidate',
                        candidate: event.candidate
                    });
                }
            };
            
            peerConnection.oniceconnectionstatechange = function() {
                console.log('ICE connection state:', peerConnection.iceConnectionState);
            };
            
            console.log('Setting remote description...');
            await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
            console.log('Creating answer...');
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            console.log('Answer created and set as local description');
            
            // Envoyer la r√©ponse avec retry
            let attempts = 0;
            let sent = false;
            while (!sent && attempts < 10) {
                if (callSocket && callSocket.readyState === WebSocket.OPEN) {
                    sent = sendCallMessage({
                        type: 'call-answer',
                        answer: answer
                    });
                    if (sent) {
                        console.log('Call answer sent successfully');
                        break;
                    }
                } else {
                    console.log('Waiting for socket to be ready, attempt', attempts + 1);
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
                attempts++;
            }
            
            if (!sent) {
                console.error('Failed to send call answer after', attempts, 'attempts');
                endCall();
                alert('Erreur: Impossible de se connecter au serveur d\'appels.');
                return;
            }
            
            isCallActive = true;
            showCallInterface(false);
            updateCallButton(true);
            console.log('Call accepted successfully');
        } catch (error) {
            console.error('Error accepting incoming call:', error);
            alert('Erreur lors de l\'acceptation de l\'appel.');
            endCall();
        }
    }
    
    // Refuser un appel entrant
    function rejectIncomingCall() {
        console.log('Rejecting incoming call');
        
        // Supprimer l'interface d'appel entrant
        const incomingCallInterface = document.getElementById('incoming-call-interface');
        if (incomingCallInterface) {
            incomingCallInterface.remove();
        }
        
        // Envoyer le signal de refus
        if (callSocket && callSocket.readyState === WebSocket.OPEN) {
            try {
                callSocket.send(JSON.stringify({ type: 'call-end' }));
                console.log('Call rejection signal sent');
            } catch (error) {
                console.error('Error sending call rejection:', error);
            }
        }
        
        // R√©initialiser les donn√©es
        incomingCallData = null;
    }
    
    // G√©rer la r√©ponse √† l'appel
    async function handleCallAnswer(data) {
        console.log('Received call answer');
        if (peerConnection) {
            try {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
                console.log('Remote description set successfully');
            } catch (error) {
                console.error('Error setting remote description:', error);
            }
        }
    }
    
    // G√©rer les candidats ICE
    async function handleIceCandidate(data) {
        console.log('Received ICE candidate');
        if (peerConnection && data.candidate) {
            try {
                await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
                console.log('ICE candidate added successfully');
            } catch (error) {
                console.error('Error adding ICE candidate:', error);
            }
        }
    }
    
    // Terminer l'appel
    function endCall() {
        console.log('Ending call...');
        
        // Arr√™ter le stream local
        if (localStream) {
            localStream.getTracks().forEach(track => {
                track.stop();
                track.enabled = false;
            });
            localStream = null;
        }
        
        // Fermer la connexion peer
        if (peerConnection) {
            peerConnection.getSenders().forEach(sender => {
                if (sender.track) {
                    sender.track.stop();
                }
            });
            peerConnection.getReceivers().forEach(receiver => {
                if (receiver.track) {
                    receiver.track.stop();
                }
            });
            peerConnection.close();
            peerConnection = null;
        }
        
        // Envoyer le signal de fin d'appel
        if (callSocket && callSocket.readyState === WebSocket.OPEN) {
            try {
                callSocket.send(JSON.stringify({ type: 'call-end' }));
                console.log('Call-end signal sent');
            } catch (error) {
                console.error('Error sending call-end:', error);
            }
        } else {
            console.warn('Socket not ready, cannot send call-end signal');
        }
        
        // Arr√™ter l'audio distant
        const remoteAudio = document.getElementById('remote-audio');
        if (remoteAudio) {
            remoteAudio.pause();
            remoteAudio.srcObject = null;
        }
        
        // Supprimer l'interface d'appel du DOM
        const callInterface = document.getElementById('call-interface');
        if (callInterface) {
            callInterface.style.display = 'none';
            setTimeout(function() {
                if (callInterface && callInterface.parentNode) {
                    callInterface.remove();
                }
            }, 100);
        }
        
        // Supprimer l'interface d'appel entrant si elle existe
        const incomingCallInterface = document.getElementById('incoming-call-interface');
        if (incomingCallInterface) {
            incomingCallInterface.remove();
        }
        
        // R√©initialiser les donn√©es d'appel entrant
        incomingCallData = null;
        
        // R√©initialiser l'√©tat
        isCallActive = false;
        updateCallButton(false);
        
        console.log('Call ended successfully');
    }
    
    // Afficher/masquer l'interface d'appel
    function showCallInterface(isCaller) {
        let callInterface = document.getElementById('call-interface');
        if (!callInterface) {
            callInterface = document.createElement('div');
            callInterface.id = 'call-interface';
            callInterface.className = 'fixed inset-0 bg-black/90 z-50 flex items-center justify-center';
            callInterface.innerHTML = `
                <div class="text-center text-white">
                    <div class="mb-6">
                        <div class="w-24 h-24 mx-auto rounded-full bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center mb-4">
                            {% if other_user.avatar %}
                                <img src="{{ other_user.avatar.url }}" alt="{{ other_user.username }}" class="w-full h-full rounded-full object-cover">
                            {% else %}
                                <span class="text-white text-3xl font-bold">{{ other_user.username|first|upper }}</span>
                            {% endif %}
                        </div>
                        <h3 class="text-2xl font-bold">{{ other_user.username }}</h3>
                        <p id="call-status" class="text-white/70 mt-2">${isCaller ? 'Appel en cours...' : 'En communication'}</p>
                    </div>
                    <audio id="remote-audio" autoplay></audio>
                    <button id="end-call-button" class="w-16 h-16 rounded-full bg-red-500 hover:bg-red-600 flex items-center justify-center transition-colors shadow-lg cursor-pointer">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                    <p class="text-white/60 text-xs mt-4">Appuyez sur le bouton pour raccrocher</p>
                </div>
            `;
            document.body.appendChild(callInterface);
            
            // Ajouter l'√©v√©nement click au bouton de fin d'appel
            setTimeout(function() {
                const endCallButton = document.getElementById('end-call-button');
                if (endCallButton) {
                    // Supprimer les anciens listeners
                    const newButton = endCallButton.cloneNode(true);
                    endCallButton.parentNode.replaceChild(newButton, endCallButton);
                    
                    // Ajouter le nouveau listener
                    document.getElementById('end-call-button').addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('End call button clicked');
                        endCall();
                    });
                }
            }, 100);
        } else {
            callInterface.style.display = 'flex';
            // R√©ajouter l'√©v√©nement si l'interface existe d√©j√†
            const endCallButton = document.getElementById('end-call-button');
            if (endCallButton) {
                // Supprimer les anciens listeners
                const newButton = endCallButton.cloneNode(true);
                endCallButton.parentNode.replaceChild(newButton, endCallButton);
                
                // Ajouter le nouveau listener
                document.getElementById('end-call-button').addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('End call button clicked (existing)');
                    endCall();
                });
            }
        }
    }
    
    // Mettre √† jour le bouton d'appel
    function updateCallButton(active) {
        const callButton = document.getElementById('call-button');
        if (callButton) {
            if (active) {
                callButton.classList.add('bg-red-500');
                callButton.classList.remove('hover:bg-white/20');
                callButton.title = 'Raccrocher';
                callButton.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    endCall();
                    return false;
                };
            } else {
                callButton.classList.remove('bg-red-500');
                callButton.classList.add('hover:bg-white/20');
                callButton.title = 'Appeler';
                callButton.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    startCall();
                    return false;
                };
            }
        }
    }
    
    // Connecter le socket d'appel au chargement
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(connectCallSocket, 500);
        });
    } else {
        setTimeout(connectCallSocket, 500);
    }
    
    // S'assurer que le socket est connect√© avant de quitter la page
    // Mais ne PAS emp√™cher la navigation normale
    window.addEventListener('beforeunload', function(e) {
        if (isCallActive) {
            endCall();
        }
        // Ne pas emp√™cher la navigation - juste nettoyer
    });
    
    // Emp√™cher les rechargements automatiques caus√©s par des erreurs
    // Protection suppl√©mentaire : intercepter toutes les tentatives de rechargement
    const preventReload = function() {
        // Sauvegarder le contenu du textarea avant tout rechargement potentiel
        if (messageInput && messageInput.value.trim()) {
            sessionStorage.setItem('chat_message_draft', messageInput.value);
        }
    };
    
    // Intercepter les √©v√©nements qui pourraient causer des rechargements
    document.addEventListener('visibilitychange', function() {
        // Si la page devient visible, red√©marrer le polling
        if (document.visibilityState === 'visible') {
            startPolling();
        }
    });
    
    // Exposer les fonctions globalement pour le d√©bogage
    window.startCall = startCall;
    window.endCall = endCall;
</script>
{% endblock %}
