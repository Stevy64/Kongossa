{% extends 'base.html' %}

{% block title %}Cr√©er un groupe - Kongossa{% endblock %}

{% block content %}
<div class="min-h-screen bg-blurred pb-20" x-data="{ activeTab: 'group' }">
    <!-- Header -->
    <div class="glass-dark tab-bar sticky top-0 z-40 backdrop-blur-xl border-b border-white/20">
        <div class="max-w-4xl mx-auto px-4 py-5 flex items-center justify-between">
            <a href="{% url 'forum:topics_list' %}" class="text-white/80 hover:text-white transition-all hover:scale-105 flex items-center space-x-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
                <span>Retour</span>
            </a>
            <h1 class="text-white text-2xl font-poppins font-bold gradient-text">Cr√©er un groupe</h1>
            <div class="w-20"></div>
        </div>
    </div>
    
    <div class="max-w-2xl mx-auto px-4 py-8">
        <!-- Onglets -->
        <div class="mb-6 flex space-x-2 bg-white/5 rounded-2xl p-2 border border-white/10">
            <button 
                @click="activeTab = 'group'"
                :class="activeTab === 'group' ? 'bg-gradient-gold text-brand-primary' : 'text-white/60 hover:text-white'"
                class="flex-1 px-6 py-3 rounded-xl font-semibold transition-all"
            >
                Cr√©er un groupe
            </button>
            <button 
                @click="activeTab = 'visual'"
                :class="activeTab === 'visual' ? 'bg-gradient-gold text-brand-primary' : 'text-white/60 hover:text-white'"
                class="flex-1 px-6 py-3 rounded-xl font-semibold transition-all"
            >
                Visuel
            </button>
        </div>
        
        <!-- Formulaire de param√®tres visuels -->
        <div x-show="activeTab === 'visual'" x-cloak class="glass-enhanced rounded-3xl p-8 border border-white/20 shadow-2xl fade-in-up">
            <form method="POST" action="{% url 'forum:create_topic' %}" enctype="multipart/form-data" class="space-y-6" id="group-visual-form">
                {% csrf_token %}
                <input type="hidden" name="form_type" value="group">
                
                <!-- Cr√©ation d'un nouveau th√®me -->
                <div x-data="{ createNewTopic: false }" class="space-y-6">
                    <div class="flex items-center justify-between p-4 rounded-2xl bg-white/5 border border-white/10">
                        <div>
                            <h3 class="text-white font-semibold mb-1">Cr√©er un nouveau th√®me</h3>
                            <p class="text-gray-400 text-sm">Cr√©ez un nouveau th√®me pour enrichir la liste des th√®mes disponibles</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" x-model="createNewTopic" name="create_new_topic" class="sr-only peer">
                            <div class="w-14 h-7 bg-white/20 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-gold rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-gold"></div>
                        </label>
                    </div>
                    
                    <!-- Formulaire de cr√©ation de th√®me -->
                    <div x-show="createNewTopic" x-cloak class="space-y-4 p-6 rounded-2xl bg-white/5 border border-white/10">
                        <h4 class="text-white font-semibold mb-4">Informations du nouveau th√®me</h4>
                        
                        <!-- Nom du th√®me -->
                        <div>
                            <label for="new-topic-name" class="block text-white font-semibold mb-2">
                                Nom du th√®me <span class="text-red-400">*</span>
                            </label>
                            <input 
                                type="text" 
                                id="new-topic-name"
                                name="new_topic_name" 
                                maxlength="100"
                                placeholder="Ex: Technologie, Sport, Musique..."
                                class="w-full px-5 py-4 rounded-2xl bg-white/10 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-gold focus:border-transparent backdrop-blur-sm transition-all"
                            >
                            <p class="text-gray-400 text-sm mt-1">Choisissez un nom clair et descriptif pour votre th√®me</p>
                        </div>
                        
                        <!-- Description du th√®me -->
                        <div>
                            <label for="new-topic-description" class="block text-white font-semibold mb-2">
                                Description du th√®me
                            </label>
                            <textarea 
                                id="new-topic-description"
                                name="new_topic_description" 
                                rows="3"
                                maxlength="500"
                                placeholder="D√©crivez bri√®vement ce th√®me..."
                                class="w-full px-5 py-4 rounded-2xl bg-white/10 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-gold focus:border-transparent resize-none backdrop-blur-sm transition-all"
                            ></textarea>
                            <p class="text-gray-400 text-sm mt-1">Une description aide les utilisateurs √† comprendre le th√®me</p>
                        </div>
                        
                        <p class="text-gray-400 text-sm italic">Note: L'ic√¥ne et la couleur d√©finis ci-dessous seront utilis√©s pour ce nouveau th√®me.</p>
                    </div>
                </div>
                
                <!-- Ic√¥ne et Couleur -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Ic√¥ne -->
                    <div>
                        <label for="group-icon" class="block text-white font-semibold mb-2">
                            Ic√¥ne (emoji)
                        </label>
                        <input 
                            type="text" 
                            id="group-icon"
                            name="icon" 
                            maxlength="2"
                            value="üí¨"
                            placeholder="üí¨"
                            class="w-full px-5 py-4 rounded-2xl bg-white/10 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-gold focus:border-transparent backdrop-blur-sm transition-all text-center text-2xl"
                        >
                        <p class="text-gray-400 text-sm mt-1">Choisissez un emoji repr√©sentatif pour votre groupe</p>
                    </div>
                    
                    <!-- Couleur -->
                    <div>
                        <label for="group-color" class="block text-white font-semibold mb-2">
                            Couleur du groupe
                        </label>
                        <div class="flex items-center space-x-3">
                            <input 
                                type="color" 
                                id="group-color"
                                name="color" 
                                value="#9333ea"
                                class="w-16 h-16 rounded-xl bg-white/10 border border-white/20 cursor-pointer"
                            >
                            <input 
                                type="text" 
                                value="#9333ea"
                                id="group-color-text"
                                class="flex-1 px-5 py-4 rounded-2xl bg-white/10 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-gold focus:border-transparent backdrop-blur-sm transition-all"
                                placeholder="#9333ea"
                            >
                        </div>
                        <p class="text-gray-400 text-sm mt-1">Couleur principale du groupe</p>
                    </div>
                </div>
                
                <!-- Preview -->
                <div class="mt-6 p-6 rounded-2xl bg-white/5 border border-white/10">
                    <p class="text-gray-400 text-sm mb-3">Aper√ßu du groupe :</p>
                    <div class="flex items-center space-x-4">
                        <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-purple-500 via-pink-500 to-orange-500 flex items-center justify-center shadow-lg" id="group-preview-icon">
                            <span class="text-3xl" id="group-preview-icon-text">üí¨</span>
                        </div>
                        <div>
                            <h3 class="text-white font-bold text-lg" id="group-preview-name">Nom du groupe</h3>
                            <p class="text-gray-300 text-sm" id="group-preview-description">Description du groupe...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Image du groupe (r√©f√©rence au champ du formulaire principal) -->
                <div>
                    <label for="group-image" class="block text-white font-semibold mb-2">
                        Image du groupe (optionnel)
                    </label>
                    <input 
                        type="file" 
                        id="group-image-visual"
                        accept="image/*"
                        class="w-full px-5 py-4 rounded-2xl bg-white/10 border border-white/20 text-white file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-gold file:text-brand-primary hover:file:bg-yellow-400"
                        onchange="syncImageFile(this)"
                    >
                    <p class="text-gray-400 text-sm mt-1">Ajoutez une image repr√©sentative de votre groupe</p>
                </div>
            
            </form>
        </div>
        
        <!-- Formulaire de cr√©ation de Groupe (informations de base) -->
        <div x-show="activeTab === 'group'" class="glass-enhanced rounded-3xl p-8 border border-white/20 shadow-2xl fade-in-up">
            <form method="POST" action="{% url 'forum:create_topic' %}" enctype="multipart/form-data" class="space-y-6" id="group-form">
                {% csrf_token %}
                <input type="hidden" name="form_type" value="group">
                
                <!-- Champs cach√©s pour les donn√©es de l'onglet Visuel -->
                <input type="hidden" name="icon" id="group-form-icon" value="üí¨">
                <input type="hidden" name="color" id="group-form-color" value="#9333ea">
                <input type="hidden" name="create_new_topic" id="group-form-create-new-topic">
                <input type="hidden" name="new_topic_name" id="group-form-new-topic-name">
                <input type="hidden" name="new_topic_description" id="group-form-new-topic-description">
                
                <!-- S√©lection du th√®me -->
                {% with first_topic=all_topics|first %}
                <div x-data="customSelect('topic', '{% if first_topic %}{{ first_topic.slug }}{% endif %}')">
                    <label class="block text-white font-semibold mb-2">
                        Th√®me <span class="text-red-400">*</span>
                    </label>
                    
                    <!-- Select cach√© pour le formulaire -->
                    <input type="hidden" name="topic" :value="selectedValue" required>
                    
                    <!-- Bouton personnalis√© -->
                    <button 
                        type="button"
                        @click="open = !open"
                        @click.away="open = false"
                        :class="open ? 'ring-2 ring-gold border-gold/50' : 'border-white/20'"
                        class="w-full px-5 py-4 rounded-2xl bg-white/10 border backdrop-blur-sm transition-all text-left flex items-center justify-between group hover:bg-white/15"
                    >
                        <div class="flex items-center space-x-3 flex-1 min-w-0">
                            <template x-if="selectedTopic">
                                <div class="flex items-center space-x-3 flex-1 min-w-0">
                                    <div class="w-10 h-10 rounded-xl flex items-center justify-center flex-shrink-0" 
                                         :style="`background: ${selectedTopic.color};`">
                                        <span x-text="selectedTopic.icon || 'üí¨'" class="text-xl"></span>
                                    </div>
                                    <span class="text-white font-medium truncate" x-text="selectedTopic.name || 'S√©lectionnez un th√®me...'"></span>
                                </div>
                            </template>
                            <template x-if="!selectedTopic">
                                <span class="text-white/60 font-medium">S√©lectionnez un th√®me...</span>
                            </template>
                        </div>
                        <svg class="w-5 h-5 text-white/60 group-hover:text-white transition-transform flex-shrink-0 ml-3" 
                             :class="open ? 'rotate-180' : ''"
                             fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>
                    
                    <!-- Dropdown -->
                    <div 
                        x-show="open"
                        x-cloak
                        x-transition:enter="transition ease-out duration-200"
                        x-transition:enter-start="opacity-0 transform scale-95 translate-y-2"
                        x-transition:enter-end="opacity-100 transform scale-100 translate-y-0"
                        x-transition:leave="transition ease-in duration-150"
                        x-transition:leave-start="opacity-100 transform scale-100 translate-y-0"
                        x-transition:leave-end="opacity-0 transform scale-95 translate-y-2"
                        class="mt-2 rounded-2xl bg-white/10 backdrop-blur-xl border border-white/20 shadow-2xl overflow-hidden z-50"
                    >
                        <!-- Recherche -->
                        <div class="p-3 border-b border-white/10">
                            <input 
                                type="text"
                                x-model="searchQuery"
                                @input="filterOptions()"
                                placeholder="Rechercher un th√®me..."
                                class="w-full px-4 py-2.5 rounded-xl bg-white/5 border border-white/10 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-gold focus:border-transparent backdrop-blur-sm text-sm"
                            >
                        </div>
                        
                        <!-- Liste des options -->
                        <div class="max-h-64 overflow-y-auto custom-scrollbar">
                            <template x-for="topic in filteredTopics" :key="topic.slug">
                                <button
                                    type="button"
                                    @click="selectTopic(topic)"
                                    :class="selectedValue === topic.slug ? 'bg-gold/20 border-gold/50' : 'hover:bg-white/10 border-transparent'"
                                    class="w-full px-4 py-3 flex items-center space-x-3 border-l-4 transition-all text-left group"
                                >
                                    <div class="w-10 h-10 rounded-xl flex items-center justify-center flex-shrink-0" 
                                         :style="`background: ${topic.color};`">
                                        <span x-text="topic.icon || 'üí¨'" class="text-xl"></span>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <div class="text-white font-medium group-hover:text-gold transition-colors" x-text="topic.name"></div>
                                        <div class="text-white/50 text-xs mt-0.5" x-text="topic.description || ''"></div>
                                    </div>
                                    <template x-if="selectedValue === topic.slug">
                                        <svg class="w-5 h-5 text-gold flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                        </svg>
                                    </template>
                                </button>
                            </template>
                            <template x-if="filteredTopics.length === 0">
                                <div class="px-4 py-8 text-center">
                                    <p class="text-white/60 text-sm">Aucun th√®me trouv√©</p>
                                </div>
                            </template>
                        </div>
                    </div>
                    
                    <p class="text-gray-400 text-sm mt-1">Choisissez le th√®me auquel appartient ce groupe</p>
                </div>
                {% endwith %}
                
                <script>
                    function customSelect(name, defaultValue = '') {
                        return {
                            open: false,
                            selectedValue: defaultValue,
                            selectedTopic: null,
                            searchQuery: '',
                            topics: [
                                {% for topic in all_topics %}
                                {
                                    slug: '{{ topic.slug }}',
                                    name: '{{ topic.name|escapejs }}',
                                    icon: '{{ topic.icon|default:"üí¨"|escapejs }}',
                                    color: '{{ topic.color|default:"#9333ea" }}',
                                    description: '{{ topic.description|default:""|escapejs|truncatewords:10 }}'
                                }{% if not forloop.last %},{% endif %}
                                {% endfor %}
                            ],
                            filteredTopics: [],
                            
                            init() {
                                this.filteredTopics = this.topics;
                                if (this.selectedValue) {
                                    this.selectedTopic = this.topics.find(t => t.slug === this.selectedValue);
                                }
                            },
                            
                            filterOptions() {
                                if (!this.searchQuery.trim()) {
                                    this.filteredTopics = this.topics;
                                    return;
                                }
                                const query = this.searchQuery.toLowerCase();
                                this.filteredTopics = this.topics.filter(topic => 
                                    topic.name.toLowerCase().includes(query) ||
                                    (topic.description && topic.description.toLowerCase().includes(query))
                                );
                            },
                            
                            selectTopic(topic) {
                                this.selectedValue = topic.slug;
                                this.selectedTopic = topic;
                                this.open = false;
                                this.searchQuery = '';
                                this.filteredTopics = this.topics;
                            }
                        }
                    }
                </script>
                
                <!-- Nom du groupe -->
                <div>
                    <label for="group-name" class="block text-white font-semibold mb-2">
                        Nom du groupe <span class="text-red-400">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="group-name"
                        name="name" 
                        required
                        maxlength="100"
                        placeholder="Ex: Groupe de discussion sur..."
                        class="w-full px-5 py-4 rounded-2xl bg-white/10 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-gold focus:border-transparent backdrop-blur-sm transition-all"
                    >
                    <p class="text-gray-400 text-sm mt-1">Choisissez un nom clair et descriptif pour votre groupe</p>
                </div>
                
                <!-- Description -->
                <div>
                    <label for="group-description" class="block text-white font-semibold mb-2">
                        Description
                    </label>
                    <textarea 
                        id="group-description"
                        name="description" 
                        rows="4"
                        maxlength="500"
                        placeholder="D√©crivez bri√®vement votre groupe..."
                        class="w-full px-5 py-4 rounded-2xl bg-white/10 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-gold focus:border-transparent resize-none backdrop-blur-sm transition-all"
                    ></textarea>
                    <p class="text-gray-400 text-sm mt-1">Une description aide les utilisateurs √† comprendre le groupe</p>
                </div>
                
                <!-- Option publique -->
                <div class="flex items-center space-x-2">
                    <input 
                        type="checkbox" 
                        name="is_public" 
                        id="is_public" 
                        checked
                        class="w-4 h-4 rounded bg-white/10 border-white/20 text-gold focus:ring-gold focus:ring-2"
                    >
                    <label for="is_public" class="text-white/80 text-sm">Groupe public (visible par tous)</label>
                </div>
                
                <!-- Image du groupe -->
                <div>
                    <label for="group-image" class="block text-white font-semibold mb-2">
                        Image du groupe (optionnel)
                    </label>
                    <input 
                        type="file" 
                        id="group-image"
                        name="image" 
                        accept="image/*"
                        class="w-full px-5 py-4 rounded-2xl bg-white/10 border border-white/20 text-white file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-gold file:text-brand-primary hover:file:bg-yellow-400"
                        onchange="syncImageFileToVisual(this)"
                    >
                    <p class="text-gray-400 text-sm mt-1">Ajoutez une image repr√©sentative de votre groupe</p>
                </div>
                
                <!-- Boutons -->
                <div class="flex items-center justify-end space-x-4 pt-4">
                    <a href="{% url 'forum:topics_list' %}" class="px-6 py-3 rounded-xl glass text-white/80 hover:text-white hover:bg-white/20 transition-all">
                        Annuler
                    </a>
                    <button 
                        type="submit"
                        class="px-6 py-3 rounded-xl bg-gradient-gold text-brand-primary font-semibold hover:shadow-gold hover:scale-105 transition-all btn-interactive"
                    >
                        Cr√©er le groupe
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Floating Chat Button (FAB) -->
    <a href="{% url 'chat:list' %}" class="fixed bottom-6 right-6 z-50 group">
        <div class="relative">
            <div class="absolute inset-0 bg-gradient-to-r from-purple-600 to-pink-600 rounded-full blur-lg opacity-50 group-hover:opacity-75 transition-opacity duration-300 animate-pulse"></div>
            <div class="relative w-14 h-14 bg-gradient-to-r from-purple-600 via-pink-600 to-orange-500 rounded-full flex items-center justify-center shadow-2xl hover:shadow-purple-500/50 transition-all duration-300 hover:scale-110 hover:rotate-12">
                <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 8.511c.884.284 1.5 1.128 1.5 2.097v4.286c0 1.136-.847 2.1-1.98 2.193-.34.027-.68.052-1.02.072v3.091l-3-3c-1.354 0-2.694-.055-4.02-.163a2.115 2.115 0 01-.825-.242m9.345-8.334a2.126 2.126 0 00-.476-.095 48.64 48.64 0 00-8.048 0c-1.131.094-1.976 1.057-1.976 2.192v4.286c0 .837.46 1.58 1.155 1.951m9.345-8.334V6.637c0-1.621-1.152-3.026-2.76-3.235A48.455 48.455 0 0011.25 3c-2.115 0-4.198.137-6.24.402-1.608.209-2.76 1.614-2.76 3.235v6.226c0 1.621 1.152 3.026 2.76 3.235.577.075 1.157.14 1.74.194V21l4.155-4.155" />
                </svg>
            </div>
        </div>
    </a>
</div>

<script>
    // Fonction pour synchroniser les valeurs de l'onglet Visuel vers le formulaire group-form
    function syncVisualToForm() {
        const visualForm = document.getElementById('group-visual-form');
        const groupForm = document.getElementById('group-form');
        
        if (!visualForm || !groupForm) return;
        
        // Copier icon et color
        const iconInput = visualForm.querySelector('#group-icon');
        const colorInput = visualForm.querySelector('#group-color');
        const createNewTopicCheckbox = visualForm.querySelector('input[name="create_new_topic"]');
        const newTopicNameInput = visualForm.querySelector('#new-topic-name');
        const newTopicDescriptionInput = visualForm.querySelector('#new-topic-description');
        
        if (iconInput) {
            const formIconInput = groupForm.querySelector('#group-form-icon');
            if (formIconInput) formIconInput.value = iconInput.value || 'üí¨';
        }
        
        if (colorInput) {
            const formColorInput = groupForm.querySelector('#group-form-color');
            if (formColorInput) formColorInput.value = colorInput.value || '#9333ea';
        }
        
        // Copier les donn√©es de cr√©ation de nouveau th√®me
        if (createNewTopicCheckbox) {
            const formCreateNewTopic = groupForm.querySelector('#group-form-create-new-topic');
            if (formCreateNewTopic) {
                formCreateNewTopic.value = createNewTopicCheckbox.checked ? 'on' : '';
            }
        }
        
        if (newTopicNameInput) {
            const formNewTopicName = groupForm.querySelector('#group-form-new-topic-name');
            if (formNewTopicName) formNewTopicName.value = newTopicNameInput.value || '';
        }
        
        if (newTopicDescriptionInput) {
            const formNewTopicDescription = groupForm.querySelector('#group-form-new-topic-description');
            if (formNewTopicDescription) formNewTopicDescription.value = newTopicDescriptionInput.value || '';
        }
    }
    
    // Mise √† jour de l'aper√ßu visuel en temps r√©el et synchronisation avec le formulaire
    document.addEventListener('DOMContentLoaded', function() {
        const groupNameInput = document.getElementById('group-name');
        const groupDescriptionInput = document.getElementById('group-description');
        const groupIconInput = document.getElementById('group-icon');
        const groupColorInput = document.getElementById('group-color');
        const groupColorTextInput = document.getElementById('group-color-text');
        const createNewTopicCheckbox = document.querySelector('input[name="create_new_topic"]');
        const newTopicNameInput = document.getElementById('new-topic-name');
        const newTopicDescriptionInput = document.getElementById('new-topic-description');
        
        const groupPreviewName = document.getElementById('group-preview-name');
        const groupPreviewDescription = document.getElementById('group-preview-description');
        const groupPreviewIcon = document.getElementById('group-preview-icon-text');
        const groupPreviewIconContainer = document.getElementById('group-preview-icon');
        
        // Synchroniser avant la soumission du formulaire
        const groupForm = document.getElementById('group-form');
        if (groupForm) {
            groupForm.addEventListener('submit', function(e) {
                syncVisualToForm();
            });
        }
        
        // Synchroniser en temps r√©el quand les valeurs changent
        if (groupIconInput) {
            groupIconInput.addEventListener('input', function() {
                if (groupPreviewIcon) {
                    groupPreviewIcon.textContent = this.value || 'üí¨';
                }
                syncVisualToForm();
            });
        }
        
        if (groupColorInput) {
            groupColorInput.addEventListener('input', function() {
                if (groupColorTextInput) {
                    groupColorTextInput.value = this.value;
                }
                if (groupPreviewIconContainer) {
                    groupPreviewIconContainer.style.background = `linear-gradient(135deg, ${this.value} 0%, ${adjustColor(this.value, 20)} 50%, ${adjustColor(this.value, 40)} 100%)`;
                }
                syncVisualToForm();
            });
        }
        
        if (groupColorTextInput) {
            groupColorTextInput.addEventListener('input', function() {
                if (/^#[0-9A-F]{6}$/i.test(this.value)) {
                    if (groupColorInput) {
                        groupColorInput.value = this.value;
                    }
                    if (groupPreviewIconContainer) {
                        groupPreviewIconContainer.style.background = `linear-gradient(135deg, ${this.value} 0%, ${adjustColor(this.value, 20)} 50%, ${adjustColor(this.value, 40)} 100%)`;
                    }
                }
                syncVisualToForm();
            });
        }
        
        if (createNewTopicCheckbox) {
            createNewTopicCheckbox.addEventListener('change', function() {
                syncVisualToForm();
            });
        }
        
        if (newTopicNameInput) {
            newTopicNameInput.addEventListener('input', function() {
                syncVisualToForm();
            });
        }
        
        if (newTopicDescriptionInput) {
            newTopicDescriptionInput.addEventListener('input', function() {
                syncVisualToForm();
            });
        }
        
        if (groupNameInput && groupPreviewName) {
            groupNameInput.addEventListener('input', function() {
                groupPreviewName.textContent = this.value || 'Nom du groupe';
            });
        }
        
        if (groupDescriptionInput && groupPreviewDescription) {
            groupDescriptionInput.addEventListener('input', function() {
                groupPreviewDescription.textContent = this.value || 'Description du groupe...';
            });
        }
        
        // Synchronisation initiale
        syncVisualToForm();
    });
    
    function adjustColor(color, percent) {
        const num = parseInt(color.replace("#",""), 16);
        const amt = Math.round(2.55 * percent);
        const R = (num >> 16) + amt;
        const G = (num >> 8 & 0x00FF) + amt;
        const B = (num & 0x0000FF) + amt;
        return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
            (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
            (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
    }
    
    // Synchronisation des fichiers image (les fichiers ne peuvent pas √™tre copi√©s directement, donc on utilise un DataTransfer)
    function syncImageFile(sourceInput) {
        const targetInput = document.getElementById('group-image');
        if (targetInput && sourceInput.files.length > 0) {
            const dataTransfer = new DataTransfer();
            for (let i = 0; i < sourceInput.files.length; i++) {
                dataTransfer.items.add(sourceInput.files[i]);
            }
            targetInput.files = dataTransfer.files;
        }
    }
    
    function syncImageFileToVisual(sourceInput) {
        const targetInput = document.getElementById('group-image-visual');
        if (targetInput && sourceInput.files.length > 0) {
            const dataTransfer = new DataTransfer();
            for (let i = 0; i < sourceInput.files.length; i++) {
                dataTransfer.items.add(sourceInput.files[i]);
            }
            targetInput.files = dataTransfer.files;
        }
    }
</script>
{% endblock %}

