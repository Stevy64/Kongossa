{% extends 'base.html' %}
{% load static %}

{% block title %}Forums de discussion - Kongossa{% endblock %}

{% block extra_css %}
<style>
    /* Animation pour les cartes */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .topic-card {
        animation: fadeInUp 0.5s ease-out;
        animation-fill-mode: both;
    }
    
    .topic-card:nth-child(1) { animation-delay: 0.1s; }
    .topic-card:nth-child(2) { animation-delay: 0.2s; }
    .topic-card:nth-child(3) { animation-delay: 0.3s; }
    .topic-card:nth-child(4) { animation-delay: 0.4s; }
    .topic-card:nth-child(5) { animation-delay: 0.5s; }
    .topic-card:nth-child(6) { animation-delay: 0.6s; }
    
    /* Menu d'actions */
    .action-menu {
        opacity: 0;
        transform: translateY(-10px);
        pointer-events: none;
        transition: all 0.2s ease;
        z-index: 1000;
    }
    
    .action-menu.show {
        opacity: 1;
        transform: translateY(0);
        pointer-events: all;
        z-index: 1000;
    }
    
    /* Hover effect pour les cartes */
    .topic-card-wrapper:hover .topic-card {
        transform: translateY(-4px);
    }
    
    /* Badge de couleur dynamique */
    .topic-color-badge {
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    
    /* Empêcher le chevauchement des menus - Menu au premier plan */
    .topic-card-wrapper {
        position: relative;
        overflow: visible !important;
    }
    
    .topic-card {
        position: relative;
        z-index: 1;
        overflow: visible !important;
    }
    
    .topic-card-wrapper .relative.flex-shrink-0 {
        position: relative;
        z-index: 10;
    }
    
    /* Boîte de dialogue stylée */
    [x-cloak] {
        display: none !important;
    }
    
    /* Améliorer l'interaction tactile sur mobile */
    .touch-manipulation {
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
        user-select: none;
    }
    
    /* Bouton menu amélioré - Taille optimale pour tous les écrans */
    .topic-card-wrapper button[aria-label="Options du forum"] {
        min-width: 2.75rem;
        min-height: 2.75rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    @media (min-width: 640px) {
        .topic-card-wrapper button[aria-label="Options du forum"] {
            min-width: 3rem;
            min-height: 3rem;
        }
    }
    
    /* Scrollbar personnalisée pour la boîte de dialogue */
    .topic-card-wrapper [x-show="showMenu"] .overflow-y-auto::-webkit-scrollbar {
        width: 6px;
    }
    
    .topic-card-wrapper [x-show="showMenu"] .overflow-y-auto::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
    }
    
    .topic-card-wrapper [x-show="showMenu"] .overflow-y-auto::-webkit-scrollbar-thumb {
        background: rgba(240, 196, 25, 0.5);
        border-radius: 10px;
    }
    
    .topic-card-wrapper [x-show="showMenu"] .overflow-y-auto::-webkit-scrollbar-thumb:hover {
        background: rgba(240, 196, 25, 0.7);
    }
    
    .grid {
        position: relative;
        z-index: 1;
    }
    
    /* Styles pour le swipe to delete */
    .topic-card-wrapper {
        position: relative;
        overflow: hidden;
    }
    
    .topic-card {
        transition: transform 0.3s ease, opacity 0.3s ease;
        will-change: transform;
    }
    
    .topic-card.swiping {
        transition: none;
    }
    
    .topic-card.swiped-out {
        transform: translateX(100%);
        opacity: 0;
    }
    
    /* Indicateur de suppression */
    .delete-indicator {
        position: absolute;
        right: 0;
        top: 0;
        bottom: 0;
        width: 80px;
        background: linear-gradient(to left, rgba(239, 68, 68, 0.9), rgba(220, 38, 38, 0.9));
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
        z-index: 0;
    }
    
    .topic-card-wrapper.show-delete .delete-indicator {
        opacity: 1;
    }
    
    /* Styles pour la barre de recherche moderne */
    .search-container input::placeholder {
        color: rgba(255, 255, 255, 0.5);
        transition: color 0.3s ease;
    }
    
    .search-container input:focus::placeholder {
        color: rgba(255, 255, 255, 0.3);
    }
    
    /* Style personnalisé pour le select */
    .search-container select {
        cursor: pointer;
    }
    
    .search-container select option {
        background-color: #1B263B;
        color: white;
        padding: 0.75rem;
    }
    
    .search-container select option:hover {
        background-color: #0D1B2A;
    }
    
    /* Animation pour les boutons */
    @keyframes pulse-glow {
        0%, 100% {
            box-shadow: 0 0 0 0 rgba(240, 196, 25, 0.7);
        }
        50% {
            box-shadow: 0 0 0 8px rgba(240, 196, 25, 0);
        }
    }
    
    .search-container button[type="submit"]:hover {
        animation: pulse-glow 2s infinite;
    }
    
    /* Amélioration du focus pour les inputs */
    .search-container input:focus,
    .search-container select:focus {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(240, 196, 25, 0.3);
    }
    
    /* Amélioration du select pour tous les navigateurs */
    .search-container select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%23F0C419%22 stroke-width=%223%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22><path d=%22M6 9l6 6 6-6%22/></svg>');
        background-repeat: no-repeat;
        background-position: right 1rem center;
        background-size: 1.25rem;
        padding-right: 3rem;
    }
    
    .search-container select::-ms-expand {
        display: none;
    }
    
    /* Style pour les options du select */
    .search-container select option {
        background: #1B263B;
        color: #FFFFFF;
        padding: 0.75rem 1rem;
        border: none;
    }
    
    .search-container select option:checked {
        background: #0D1B2A;
        color: #F0C419;
    }
    
    .search-container select option:hover {
        background: #0D1B2A;
    }
    
    /* Responsive pour la barre de recherche */
    @media (max-width: 640px) {
        .search-container {
            padding: 1rem;
        }
        
        .search-container input,
        .search-container select {
            font-size: 0.875rem;
            padding: 0.75rem 0.75rem 0.75rem 2.75rem;
        }
        
        .search-container select {
            padding-right: 2.5rem;
            background-size: 1rem;
            background-position: right 0.75rem center;
        }
    }
    
    /* Animation de focus pour les champs */
    @keyframes inputFocus {
        0% {
            box-shadow: 0 0 0 0 rgba(240, 196, 25, 0.4);
        }
        100% {
            box-shadow: 0 0 0 4px rgba(240, 196, 25, 0);
        }
    }
    
    .search-container input:focus,
    .search-container select:focus {
        animation: inputFocus 0.6s ease-out;
    }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<!-- Boîte de dialogue de confirmation de suppression -->
<div id="delete-confirm-dialog" x-data="{ show: false, topicSlug: '', topicName: '' }" x-show="show" x-cloak
     @keydown.escape.window="show = false"
     class="fixed inset-0 z-[99999] flex items-center justify-center p-4"
     style="background: rgba(13, 27, 42, 0.9); backdrop-filter: blur(8px);">
    <div @click.stop
         x-transition:enter="transition ease-out duration-300 transform"
         x-transition:enter-start="opacity-0 scale-95 translate-y-4"
         x-transition:enter-end="opacity-100 scale-100 translate-y-0"
         x-transition:leave="transition ease-in duration-200 transform"
         x-transition:leave-start="opacity-100 scale-100 translate-y-0"
         x-transition:leave-end="opacity-0 scale-95 translate-y-4"
         class="bg-gradient-to-br from-brand-surface via-brand-surface/95 to-brand-surface/90 backdrop-blur-xl rounded-2xl shadow-2xl border border-red-500/30 w-full max-w-sm p-6">
        
        <!-- Icône d'avertissement -->
        <div class="flex justify-center mb-4">
            <div class="w-16 h-16 rounded-full bg-red-500/20 flex items-center justify-center">
                <svg class="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                </svg>
            </div>
        </div>
        
        <!-- Titre -->
        <h3 class="text-white font-bold text-lg text-center mb-2">Confirmer la suppression</h3>
        
        <!-- Message -->
        <p class="text-white/80 text-sm text-center mb-1">
            Êtes-vous absolument sûr de vouloir supprimer le forum
        </p>
        <p class="text-red-400 font-semibold text-base text-center mb-4" x-text="topicName"></p>
        <p class="text-white/70 text-xs text-center mb-6">
            ⚠️ Cette action est <span class="font-bold text-red-400">irréversible</span> et supprimera toutes les discussions associées.
        </p>
        
        <!-- Boutons d'action -->
        <div class="flex gap-3">
            <button @click="show = false" 
                    class="flex-1 px-4 py-2.5 bg-white/10 hover:bg-white/20 text-white font-semibold rounded-xl transition-all duration-200 touch-manipulation">
                Annuler
            </button>
            <button @click="window.confirmDelete()" 
                    class="flex-1 px-4 py-2.5 bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-semibold rounded-xl transition-all duration-200 touch-manipulation shadow-lg hover:shadow-xl">
                Supprimer
            </button>
        </div>
    </div>
</div>

<div class="min-h-screen bg-gradient-to-br from-brand-primary via-brand-primary/95 to-brand-surface pb-20">
    <!-- Header - Tab bar plus foncée -->
    <div class="glass-dark tab-bar sticky top-0 z-40 backdrop-blur-xl border-b border-white/10">
        <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
            <a href="{% url 'forum:feed' %}" class="text-white/80 hover:text-white transition-all hover:scale-105 flex items-center space-x-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
                <span class="hidden sm:inline">Retour</span>
            </a>
            <h1 class="text-white text-xl md:text-2xl font-calligraphy">Forums de discussion</h1>
            <div class="flex items-center space-x-2">
                <a href="{% url 'forum:create_topic' %}" class="flex items-center space-x-2 px-4 py-2 rounded-xl bg-gradient-to-r from-gold to-yellow-400 text-brand-primary hover:opacity-90 transition-all duration-300 hover:scale-105 shadow-lg font-semibold">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                    </svg>
                    <span class="text-sm hidden sm:inline">Nouveau sujet</span>
                </a>
            </div>
        </div>
    </div>
    
    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Barre de recherche moderne -->
        <div class="mb-8 search-container bg-gradient-to-br from-white/15 via-white/10 to-white/5 backdrop-blur-xl rounded-3xl p-5 sm:p-6 border border-white/30 shadow-2xl">
            <form method="get" action="{% url 'forum:topics_list' %}" class="space-y-4">
                <div class="flex flex-col lg:flex-row gap-4">
                    <!-- Search Input avec icône -->
                    <div class="flex-1 relative group">
                        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                            <svg class="w-5 h-5 sm:w-6 sm:h-6 text-white/60 group-focus-within:text-gold transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            </svg>
                        </div>
                        <input 
                            type="text" 
                            name="q" 
                            value="{{ search_query }}"
                            placeholder="Rechercher des groupes par nom, description..." 
                            class="w-full pl-12 pr-4 py-3.5 sm:py-4 bg-white/20 backdrop-blur-sm border-2 border-white/30 rounded-2xl text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-gold focus:border-gold/50 transition-all duration-300 text-sm sm:text-base shadow-lg hover:shadow-xl hover:bg-white/25"
                        />
                    </div>
                    
                    <!-- Topic Filter avec icône -->
                    <div class="lg:w-72 relative group">
                        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none z-10">
                            <svg class="w-5 h-5 sm:w-6 sm:h-6 text-white/60 group-focus-within:text-gold transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                            </svg>
                        </div>
                        <select 
                            name="topic" 
                            class="w-full pl-12 pr-10 py-3.5 sm:py-4 bg-white/20 backdrop-blur-sm border-2 border-white/30 rounded-2xl text-white focus:outline-none focus:ring-2 focus:ring-gold focus:border-gold/50 transition-all duration-300 text-sm sm:text-base shadow-lg hover:shadow-xl hover:bg-white/25 appearance-none cursor-pointer"
                            style="background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22white%22 stroke-width=%222%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22><path d=%22M6 9l6 6 6-6%22/></svg>'); background-repeat: no-repeat; background-position: right 1rem center; background-size: 1.5rem;"
                        >
                            <option value="" class="bg-brand-surface text-white">Tous les thèmes</option>
                            {% for topic in all_topics %}
                                <option value="{{ topic.slug }}" {% if selected_topic == topic.slug %}selected{% endif %} class="bg-brand-surface text-white">
                                    {{ topic.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Search Button -->
                    <button 
                        type="submit"
                        name="show"
                        value="groups"
                        class="px-6 sm:px-8 py-3.5 sm:py-4 bg-gradient-to-r from-gold via-yellow-400 to-gold text-brand-navy font-bold rounded-2xl transition-all duration-300 shadow-lg hover:shadow-2xl hover:scale-105 active:scale-95 flex items-center justify-center gap-2 min-w-[140px] sm:min-w-[160px]"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                        <span class="text-sm sm:text-base">Rechercher</span>
                    </button>
                    
                    <!-- Clear Button (si recherche active) -->
                    {% if search_query or selected_topic %}
                    <a href="{% url 'forum:topics_list' %}" class="px-6 sm:px-8 py-3.5 sm:py-4 bg-white/10 hover:bg-white/20 text-white font-semibold rounded-2xl transition-all duration-300 border-2 border-white/30 hover:border-white/50 shadow-lg hover:shadow-xl hover:scale-105 active:scale-95 flex items-center justify-center gap-2 min-w-[120px] sm:min-w-[140px]">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                        <span class="text-sm sm:text-base">Effacer</span>
                    </a>
                    {% endif %}
                </div>
            </form>
        </div>

        <!-- Résultats de recherche de groupes / Groupes abonnés -->
        {% if show_groups and groups %}
            <div class="mb-8">
                <h2 class="text-white text-xl font-semibold mb-6">
                    {% if search_query %}
                        Groupes trouvés ({{ groups.count }})
                    {% else %}
                        Mes groupes ({{ groups.count }})
                    {% endif %}
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {% for group in groups %}
                        <div class="topic-card-wrapper relative group" x-data="{ showMenu: false }" style="z-index: auto; position: relative;">
                            <div class="topic-card glass-enhanced rounded-3xl p-6 h-full border border-white/20 hover:border-white/30 transition-all duration-300 cursor-pointer relative" 
                                 data-group-id="{{ group.id }}"
                                 data-group-slug="{{ group.id }}"
                                 style="background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);">
                                
                                <!-- Header avec icône et menu -->
                                <div class="flex items-start justify-between mb-4">
                                    <div class="flex items-center space-x-4 flex-1 min-w-0">
                                        <!-- Badge de couleur avec icône -->
                                        <div class="topic-color-badge w-14 h-14 rounded-2xl flex items-center justify-center flex-shrink-0 transform group-hover:scale-110 group-hover:rotate-3 transition-all duration-300" 
                                             style="background: {{ group.topic.color }};">
                                            {% if group.image %}
                                                <img src="{{ group.image.url }}" alt="{{ group.name }}" class="w-full h-full rounded-2xl object-cover">
                                            {% else %}
                                                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                                                </svg>
                                            {% endif %}
                                        </div>
                                        
                                        <!-- Titre et stats -->
                                        <div class="flex-1 min-w-0">
                                            <a href="{% url 'forum:group_feed' group.id %}" class="block">
                                                <h3 class="text-white font-semibold text-lg mb-1 group-hover:text-gold transition-colors line-clamp-1">
                                                    {{ group.name }}
                                                </h3>
                                            </a>
                                            <div class="flex items-center space-x-2 text-sm">
                                                <span class="text-gold font-medium">{{ group.members_count }}</span>
                                                <span class="text-white/60">membre{{ group.members_count|pluralize }}</span>
                                                {% if group.subscribers_count > 0 %}
                                                    <span class="text-white/40">·</span>
                                                    <span class="text-white/60">{{ group.subscribers_count }} abonné{{ group.subscribers_count|pluralize }}</span>
                                                {% endif %}
                                            </div>
                                            <p class="text-white/50 text-xs mt-1 line-clamp-1">
                                                Groupe créé par {{ group.creator.username }}
                                            </p>
                                        </div>
                                    </div>
                                    
                                    <!-- Menu d'actions -->
                                    <div class="relative flex-shrink-0">
                                        <button @click="showMenu = true" 
                                                class="p-2.5 sm:p-3 rounded-xl sm:rounded-2xl text-white/70 hover:text-white hover:bg-white/15 active:bg-white/20 transition-all duration-200 relative z-10 touch-manipulation min-w-[2.75rem] min-h-[2.75rem] sm:min-w-[3rem] sm:min-h-[3rem] flex items-center justify-center shadow-lg hover:shadow-xl"
                                                aria-label="Options du groupe">
                                            <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                                            </svg>
                                        </button>
                                    </div>
                                    
                                    <!-- Boîte de dialogue stylée pour les groupes -->
                                    <div x-show="showMenu" 
                                         x-cloak
                                         @click.away="showMenu = false"
                                         @keydown.escape.window="showMenu = false"
                                         x-transition:enter="transition ease-out duration-300"
                                         x-transition:enter-start="opacity-0"
                                         x-transition:enter-end="opacity-100"
                                         x-transition:leave="transition ease-in duration-200"
                                         x-transition:leave-start="opacity-100"
                                         x-transition:leave-end="opacity-0"
                                         class="fixed inset-0 z-[99999] flex items-center justify-center p-4"
                                         style="background: rgba(13, 27, 42, 0.85); backdrop-filter: blur(8px);">
                                        
                                        <!-- Contenu de la boîte de dialogue -->
                                        <div @click.stop
                                             x-transition:enter="transition ease-out duration-300 transform"
                                             x-transition:enter-start="opacity-0 scale-95 translate-y-4"
                                             x-transition:enter-end="opacity-100 scale-100 translate-y-0"
                                             x-transition:leave="transition ease-in duration-200 transform"
                                             x-transition:leave-start="opacity-100 scale-100 translate-y-0"
                                             x-transition:leave-end="opacity-0 scale-95 translate-y-4"
                                             class="bg-gradient-to-br from-brand-surface via-brand-surface/95 to-brand-surface/90 backdrop-blur-xl rounded-2xl shadow-2xl border border-white/30 w-full max-w-xs sm:max-w-sm p-4">
                                            
                                            <!-- Header de la boîte de dialogue -->
                                            <div class="flex items-center justify-between mb-4 pb-3 border-b border-white/10">
                                                <div class="flex items-center gap-2 flex-1 min-w-0">
                                                    <div class="w-10 h-10 rounded-xl flex items-center justify-center flex-shrink-0" style="background: {{ group.topic.color }};">
                                                        {% if group.image %}
                                                            <img src="{{ group.image.url }}" alt="{{ group.name }}" class="w-full h-full rounded-xl object-cover">
                                                        {% else %}
                                                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                                                                <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                                                            </svg>
                                                        {% endif %}
                                                    </div>
                                                    <div class="min-w-0 flex-1">
                                                        <h3 class="text-white font-bold text-base sm:text-lg truncate">{{ group.name }}</h3>
                                                        <p class="text-white/60 text-xs">{{ group.members_count }} membre{{ group.members_count|pluralize }} • {{ group.subscribers_count }} abonné{{ group.subscribers_count|pluralize }}</p>
                                                    </div>
                                                </div>
                                                <button @click="showMenu = false" 
                                                        class="p-1.5 rounded-lg text-white/60 hover:text-white hover:bg-white/10 transition-all duration-200 touch-manipulation flex-shrink-0 ml-2">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                                                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                                                    </svg>
                                                </button>
                                            </div>
                                            
                                            <!-- Options en grille 2x2 -->
                                            <div class="grid grid-cols-2 gap-1.5 sm:gap-2">
                                                <!-- Option: S'abonner/Se désabonner -->
                                                {% if group.id in subscribed_group_ids %}
                                                <form method="post" action="{% url 'forum:toggle_group_subscribe' group.id %}" class="contents">
                                                    {% csrf_token %}
                                                    <button type="submit" 
                                                            @click="showMenu = false"
                                                            class="flex flex-col items-center justify-center px-2 py-2.5 bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded-lg transition-all duration-200 touch-manipulation group">
                                                        <div class="w-8 h-8 sm:w-9 sm:h-9 rounded-lg bg-red-500/20 flex items-center justify-center group-hover:scale-110 transition-transform mb-1.5">
                                                            <svg class="w-4 h-4 sm:w-4.5 sm:h-4.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                                                                <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                                                            </svg>
                                                        </div>
                                                        <div class="text-center">
                                                            <span class="text-[10px] sm:text-xs font-semibold block leading-tight">Se désabonner</span>
                                                        </div>
                                                    </button>
                                                </form>
                                                {% else %}
                                                <form method="post" action="{% url 'forum:toggle_group_subscribe' group.id %}" class="contents">
                                                    {% csrf_token %}
                                                    <button type="submit" 
                                                            @click="showMenu = false"
                                                            class="flex flex-col items-center justify-center px-2 py-2.5 bg-yellow-400/20 hover:bg-yellow-400/30 text-yellow-400 rounded-lg transition-all duration-200 touch-manipulation group">
                                                        <div class="w-8 h-8 sm:w-9 sm:h-9 rounded-lg bg-yellow-400/20 flex items-center justify-center group-hover:scale-110 transition-transform mb-1.5">
                                                            <svg class="w-4 h-4 sm:w-4.5 sm:h-4.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                                                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                                                            </svg>
                                                        </div>
                                                        <div class="text-center">
                                                            <span class="text-[10px] sm:text-xs font-semibold block leading-tight">
                                                                {% if group.requires_approval %}Demander{% else %}S'abonner{% endif %}
                                                            </span>
                                                        </div>
                                                    </button>
                                                </form>
                                                {% endif %}
                                                
                                                <!-- Option: Accéder au groupe -->
                                                <a href="{% url 'forum:group_feed' group.id %}" 
                                                   @click="showMenu = false"
                                                   class="flex flex-col items-center justify-center px-2 py-2.5 bg-white/5 hover:bg-white/10 text-white rounded-lg transition-all duration-200 touch-manipulation group">
                                                    <div class="w-8 h-8 sm:w-9 sm:h-9 rounded-lg bg-white/10 flex items-center justify-center group-hover:scale-110 transition-transform mb-1.5">
                                                        <svg class="w-4 h-4 sm:w-4.5 sm:h-4.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                                                            <path stroke-linecap="round" stroke-linejoin="round" d="M13 7l5 5m0 0l-5 5m5-5H6" />
                                                        </svg>
                                                    </div>
                                                    <div class="text-center">
                                                        <span class="text-[10px] sm:text-xs font-semibold block leading-tight">Accéder</span>
                                                    </div>
                                                </a>
                                                
                                                <!-- Placeholders pour la grille 2x2 -->
                                                <div></div>
                                                <div></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Lien vers les discussions -->
                                <div class="mt-4 pt-4 border-t border-white/10">
                                    <a href="{% url 'forum:group_feed' group.id %}" class="flex items-center justify-between text-gold hover:text-gold/80 transition-colors group">
                                        <span class="text-sm font-medium">Voir les discussions</span>
                                        <svg class="w-4 h-4 transform group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M13 7l5 5m0 0l-5 5m5-5H6" />
                                        </svg>
                                    </a>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% elif show_groups and not groups %}
            <div class="mb-8 bg-white/85 backdrop-blur-sm rounded-3xl shadow-xl p-12 text-center border border-white/30">
                <svg class="w-16 h-16 mx-auto text-brand-navy/50 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
                <h3 class="text-xl font-bold text-brand-navy mb-2">Aucun groupe trouvé</h3>
                <p class="text-brand-navy/70">
                    {% if search_query %}
                        Aucun groupe ne correspond à votre recherche "{{ search_query }}".
                    {% else %}
                        Aucun groupe public disponible pour le moment.
                    {% endif %}
                </p>
            </div>
        {% endif %}

        <!-- Liste des topics -->
        {% if topics %}
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {% for topic in topics %}
                    <div class="topic-card-wrapper relative group" x-data="{ showMenu: false }" style="z-index: auto; position: relative;">
                        <div class="topic-card glass-enhanced rounded-3xl p-6 h-full border border-white/20 hover:border-white/30 transition-all duration-300 cursor-pointer relative {% if topic.id not in subscribed_topic_ids %}opacity-60 grayscale{% endif %}"
                             data-topic-id="{{ topic.id }}"
                             data-topic-slug="{{ topic.slug }}"
                             {% if topic.id not in subscribed_topic_ids %}data-unsubscribed="true"{% endif %}
                             style="background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);">
                            
                            <!-- Header avec icône et menu -->
                            <div class="flex items-start justify-between mb-4">
                                <div class="flex items-center space-x-4 flex-1 min-w-0">
                                    <!-- Badge de couleur avec icône -->
                                    <div class="topic-color-badge w-14 h-14 rounded-2xl flex items-center justify-center flex-shrink-0 transform group-hover:scale-110 group-hover:rotate-3 transition-all duration-300" 
                                         style="background: {{ topic.color }};">
                                        {% if topic.icon|length > 2 %}
                                            <span class="text-3xl">{{ topic.icon }}</span>
                                        {% else %}
                                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                                            </svg>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Titre et stats -->
                                    <div class="flex-1 min-w-0">
                                        <a href="{% url 'forum:topic_detail' topic.slug %}" class="block">
                                            <h3 class="text-white font-semibold text-lg mb-1 group-hover:text-gold transition-colors line-clamp-1">
                                                {{ topic.name }}
                                            </h3>
                                        </a>
                                        <div class="flex items-center space-x-2 text-sm">
                                            <span class="text-gold font-medium">{{ topic.posts_count }}</span>
                                            <span class="text-white/60">discussion{{ topic.posts_count|pluralize }}</span>
                                            {% if topic.subscribers_count > 0 %}
                                                <span class="text-white/40">·</span>
                                                <span class="text-white/60" data-topic-subscribers="{{ topic.id }}">{{ topic.subscribers_count }} abonné{{ topic.subscribers_count|pluralize }}</span>
                                            {% else %}
                                                <span class="text-white/60" data-topic-subscribers="{{ topic.id }}" style="display: none;"></span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Menu d'actions -->
                                <div class="relative flex-shrink-0">
                                    <button @click="showMenu = true" 
                                            class="p-2.5 sm:p-3 rounded-xl sm:rounded-2xl text-white/70 hover:text-white hover:bg-white/15 active:bg-white/20 transition-all duration-200 relative z-10 touch-manipulation min-w-[2.75rem] min-h-[2.75rem] sm:min-w-[3rem] sm:min-h-[3rem] flex items-center justify-center shadow-lg hover:shadow-xl"
                                            aria-label="Options du forum">
                                        <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                                        </svg>
                                    </button>
                                </div>
                                
                                <!-- Boîte de dialogue stylée -->
                                <div x-show="showMenu" 
                                     x-cloak
                                     @click.away="showMenu = false"
                                     @keydown.escape.window="showMenu = false"
                                     x-transition:enter="transition ease-out duration-300"
                                     x-transition:enter-start="opacity-0"
                                     x-transition:enter-end="opacity-100"
                                     x-transition:leave="transition ease-in duration-200"
                                     x-transition:leave-start="opacity-100"
                                     x-transition:leave-end="opacity-0"
                                     class="fixed inset-0 z-[99999] flex items-center justify-center p-4"
                                     style="background: rgba(13, 27, 42, 0.85); backdrop-filter: blur(8px);">
                                    
                                    <!-- Contenu de la boîte de dialogue -->
                                    <div @click.stop
                                         x-transition:enter="transition ease-out duration-300 transform"
                                         x-transition:enter-start="opacity-0 scale-95 translate-y-4"
                                         x-transition:enter-end="opacity-100 scale-100 translate-y-0"
                                         x-transition:leave="transition ease-in duration-200 transform"
                                         x-transition:leave-start="opacity-100 scale-100 translate-y-0"
                                         x-transition:leave-end="opacity-0 scale-95 translate-y-4"
                                         class="bg-gradient-to-br from-brand-surface via-brand-surface/95 to-brand-surface/90 backdrop-blur-xl rounded-2xl shadow-2xl border border-white/30 w-full max-w-xs sm:max-w-sm p-4">
                                        
                                        <!-- Header de la boîte de dialogue -->
                                        <div class="flex items-center justify-between mb-4 pb-3 border-b border-white/10">
                                            <div class="flex items-center gap-2 flex-1 min-w-0">
                                                <div class="w-10 h-10 rounded-xl flex items-center justify-center flex-shrink-0" style="background: {{ topic.color }};">
                                                    {% if topic.icon|length > 2 %}
                                                        <span class="text-xl">{{ topic.icon }}</span>
                                                    {% else %}
                                                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                                                            <path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                                                        </svg>
                                                    {% endif %}
                                                </div>
                                                <div class="min-w-0 flex-1">
                                                    <h3 class="text-white font-bold text-base sm:text-lg truncate">{{ topic.name }}</h3>
                                                    <p class="text-white/60 text-xs">{{ topic.posts_count }} discussion{{ topic.posts_count|pluralize }} • {{ topic.subscribers_count }} abonné{{ topic.subscribers_count|pluralize }}</p>
                                                </div>
                                            </div>
                                            <button @click="showMenu = false" 
                                                    class="p-1.5 rounded-lg text-white/60 hover:text-white hover:bg-white/10 transition-all duration-200 touch-manipulation flex-shrink-0 ml-2">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                                                </svg>
                                            </button>
                                        </div>
                                        
                                        <!-- Options en grille 2x2 -->
                                        <div class="grid grid-cols-2 gap-1.5 sm:gap-2">
                                            <!-- Option: S'abonner/Se désabonner -->
                                            <button onclick="toggleSubscribe('{{ topic.slug }}', {{ topic.id }}, this);" 
                                                    id="subscribe-btn-{{ topic.id }}"
                                                    class="flex flex-col items-center justify-center px-2 py-2.5 {% if topic.id in subscribed_topic_ids %}bg-yellow-400/20 hover:bg-yellow-400/30 text-yellow-400{% else %}bg-white/5 hover:bg-white/10 text-white{% endif %} rounded-lg transition-all duration-200 touch-manipulation group">
                                                <div class="w-8 h-8 sm:w-9 sm:h-9 rounded-lg {% if topic.id in subscribed_topic_ids %}bg-yellow-400/20{% else %}bg-white/10{% endif %} flex items-center justify-center group-hover:scale-110 transition-transform mb-1.5">
                                                    <svg class="w-4 h-4 sm:w-4.5 sm:h-4.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                                                        {% if topic.id in subscribed_topic_ids %}
                                                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                                                        {% else %}
                                                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                                                        {% endif %}
                                                    </svg>
                                                </div>
                                                <div class="text-center">
                                                    <span class="text-[10px] sm:text-xs font-semibold block leading-tight" id="subscribe-text-{{ topic.id }}">
                                                        {% if topic.id in subscribed_topic_ids %}Se désabonner{% else %}S'abonner{% endif %}
                                                    </span>
                                                </div>
                                            </button>
                                            
                                            <!-- Option: Explorer ou Supprimer selon l'abonnement -->
                                            {% if topic.id in subscribed_topic_ids %}
                                            <a href="{% url 'forum:topic_detail' topic.slug %}" 
                                               @click="showMenu = false"
                                               class="flex flex-col items-center justify-center px-2 py-2.5 bg-white/5 hover:bg-white/10 text-white rounded-lg transition-all duration-200 touch-manipulation group">
                                                <div class="w-8 h-8 sm:w-9 sm:h-9 rounded-lg bg-white/10 flex items-center justify-center group-hover:scale-110 transition-transform mb-1.5">
                                                    <svg class="w-4 h-4 sm:w-4.5 sm:h-4.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                                                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                                    </svg>
                                                </div>
                                                <div class="text-center">
                                                    <span class="text-[10px] sm:text-xs font-semibold block leading-tight">Explorer</span>
                                                </div>
                                            </a>
                                            {% else %}
                                            <button onclick="removeTopicFromList('{{ topic.slug }}', {{ topic.id }}, this);" 
                                                    class="flex flex-col items-center justify-center px-2 py-2.5 bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded-lg transition-all duration-200 touch-manipulation group">
                                                <div class="w-8 h-8 sm:w-9 sm:h-9 rounded-lg bg-red-500/20 flex items-center justify-center group-hover:scale-110 transition-transform mb-1.5">
                                                    <svg class="w-4 h-4 sm:w-4.5 sm:h-4.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                                                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                    </svg>
                                                </div>
                                                <div class="text-center">
                                                    <span class="text-[10px] sm:text-xs font-semibold block leading-tight">Supprimer</span>
                                                </div>
                                            </button>
                                            {% endif %}
                                            
                                            <!-- Option: Gérer (si créateur) -->
                                            {% if topic.creator == user %}
                                            <a href="{% url 'forum:manage_topic' topic.slug %}" 
                                               @click="showMenu = false"
                                               class="flex flex-col items-center justify-center px-2 py-2.5 bg-white/5 hover:bg-white/10 text-white rounded-lg transition-all duration-200 touch-manipulation group">
                                                <div class="w-8 h-8 sm:w-9 sm:h-9 rounded-lg bg-white/10 flex items-center justify-center group-hover:scale-110 transition-transform mb-1.5">
                                                    <svg class="w-4 h-4 sm:w-4.5 sm:h-4.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                                                        <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                                    </svg>
                                                </div>
                                                <div class="text-center">
                                                    <span class="text-[10px] sm:text-xs font-semibold block leading-tight">Gérer</span>
                                                </div>
                                            </a>
                                            {% else %}
                                            <!-- Placeholder vide si pas créateur -->
                                            <div></div>
                                            {% endif %}
                                            
                                            <!-- Option: Supprimer (si créateur) -->
                                            {% if topic.creator == user %}
                                            <button onclick="deleteTopic('{{ topic.slug }}', '{{ topic.name }}'); showMenu = false;" 
                                                    class="flex flex-col items-center justify-center px-2 py-2.5 bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded-lg transition-all duration-200 touch-manipulation group">
                                                <div class="w-8 h-8 sm:w-9 sm:h-9 rounded-lg bg-red-500/20 flex items-center justify-center group-hover:scale-110 transition-transform mb-1.5">
                                                    <svg class="w-4 h-4 sm:w-4.5 sm:h-4.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                                                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                    </svg>
                                                </div>
                                                <div class="text-center">
                                                    <span class="text-[10px] sm:text-xs font-semibold block leading-tight">Supprimer</span>
                                                </div>
                                            </button>
                                            {% else %}
                                            <!-- Placeholder vide si pas créateur -->
                                            <div></div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Description -->
                            {% if topic.description %}
                                <p class="text-white/70 text-sm line-clamp-2 leading-relaxed mb-4">
                                    {{ topic.description }}
                                </p>
                            {% endif %}
                            
                            <!-- Footer avec lien d'exploration -->
                            <div class="pt-4 border-t border-white/10">
                                <a href="{% url 'forum:topic_detail' topic.slug %}" 
                                   class="flex items-center justify-between text-gold text-sm font-medium group-hover:text-yellow-400 transition-colors">
                                    <span>Voir les discussions</span>
                                    <svg class="w-4 h-4 transform group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                    </svg>
                                </a>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="glass-enhanced rounded-3xl p-12 text-center border border-white/20">
                <div class="flex justify-center mb-4">
                    <svg class="w-16 h-16 text-gold/60" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 18v-5.25m0 0a6.01 6.01 0 001.5-.189m-1.5.189a6.01 6.01 0 01-1.5-.189m3.75 7.478a12.06 12.06 0 01-4.5 0m4.5 0a12.05 12.05 0 01-3.75-1.5m-1.5 0a12.05 12.05 0 00-3.75 1.5m1.5 0a12.06 12.06 0 014.5 0M9 9.75a3 3 0 11-6 0 3 3 0 016 0zm12 0a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </div>
                <p class="text-white text-lg font-semibold mb-2">Aucun forum disponible</p>
                <p class="text-white/60 text-sm">Les forums de discussion seront bientôt disponibles</p>
                <a href="{% url 'forum:create_topic' %}" class="inline-flex items-center space-x-2 mt-6 px-6 py-3 rounded-xl bg-gradient-to-r from-gold to-yellow-400 text-brand-primary hover:opacity-90 transition-all duration-300 hover:scale-105 shadow-lg font-semibold">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                    </svg>
                    <span>Créer un forum</span>
                </a>
            </div>
        {% endif %}
    </div>
</div>

<!-- Scripts pour les actions -->
<script>
    // Fonction pour archiver un topic
    function archiveTopic(slug, name) {
        if (!confirm(`Êtes-vous sûr de vouloir archiver le forum "${name}" ?\n\nIl sera masqué mais pourra être restauré plus tard.`)) {
            return;
        }
        
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken');
        fetch(`{% url 'forum:archive_topic' 'SLUG_PLACEHOLDER' %}`.replace('SLUG_PLACEHOLDER', slug), {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Afficher une notification de succès
                showNotification('Forum archivé avec succès', 'success');
                // Recharger la page après un court délai
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showNotification(data.error || 'Erreur lors de l\'archivage', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Erreur lors de l\'archivage', 'error');
        });
    }
    
    // Fonction pour afficher la boîte de dialogue de confirmation de suppression
    function deleteTopic(slug, name) {
        const dialog = document.getElementById('delete-confirm-dialog');
        if (!dialog) {
            // Fallback si la boîte de dialogue n'existe pas
            if (!confirm(`⚠️ ATTENTION : Êtes-vous absolument sûr de vouloir supprimer le forum "${name}" ?\n\nCette action est irréversible et supprimera toutes les discussions associées.`)) {
                return;
            }
            performDelete(slug, name);
            return;
        }
        
        // Utiliser Alpine.js pour afficher la boîte de dialogue
        if (typeof Alpine !== 'undefined' && Alpine.$data) {
            const alpineData = Alpine.$data(dialog);
            alpineData.topicSlug = slug;
            alpineData.topicName = name;
            alpineData.show = true;
            
            // Stocker la fonction de confirmation dans l'élément pour y accéder depuis Alpine
            dialog._confirmDelete = function() {
                performDelete(slug, name);
                alpineData.show = false;
            };
        } else {
            // Fallback si Alpine.js n'est pas disponible
            dialog.querySelector('[x-text="topicName"]').textContent = name;
            dialog.style.display = 'flex';
            dialog._confirmDelete = function() {
                performDelete(slug, name);
                dialog.style.display = 'none';
            };
        }
    }
    
    // Fonction Alpine.js pour confirmer la suppression
    function confirmDelete() {
        const dialog = document.getElementById('delete-confirm-dialog');
        if (dialog && dialog._confirmDelete) {
            dialog._confirmDelete();
        }
    }
    
    // Fonction pour effectuer la suppression
    function performDelete(slug, name) {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken');
        fetch(`{% url 'forum:delete_topic' 'SLUG_PLACEHOLDER' %}`.replace('SLUG_PLACEHOLDER', slug), {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Forum supprimé avec succès', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showNotification(data.error || 'Erreur lors de la suppression', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Erreur lors de la suppression', 'error');
        });
    }
    
    // Fonction pour obtenir le cookie CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Fonction pour s'abonner/se désabonner d'un topic
    function toggleSubscribe(slug, topicId, buttonElement) {
        // Fermer la boîte de dialogue si elle est ouverte
        const dialog = buttonElement?.closest('[x-data]');
        if (dialog && typeof Alpine !== 'undefined' && Alpine.$data) {
            try {
                const alpineData = Alpine.$data(dialog);
                if (alpineData && typeof alpineData.showMenu !== 'undefined') {
                    alpineData.showMenu = false;
                }
            } catch (e) {
                console.log('Dialog already closed or not Alpine managed');
            }
        }
        
        const btn = document.getElementById(`subscribe-btn-${topicId}`);
        const text = document.getElementById(`subscribe-text-${topicId}`);
        const topicCard = document.querySelector(`[data-topic-id="${topicId}"]`);
        
        if (!btn || !text) {
            console.error('Bouton ou texte non trouvé pour topicId:', topicId);
            showNotification('Erreur: élément non trouvé', 'error');
            return;
        }
        
        const originalText = text.textContent;
        const originalClasses = btn.className;
        const wasSubscribed = btn.classList.contains('text-yellow-400');
        
        // Désactiver le bouton pendant la requête
        btn.disabled = true;
        btn.style.opacity = '0.6';
        btn.style.cursor = 'not-allowed';
        
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken');
        
        if (!csrfToken) {
            console.error('Token CSRF non trouvé');
            showNotification('Erreur: token de sécurité manquant', 'error');
            btn.disabled = false;
            btn.style.opacity = '1';
            btn.style.cursor = 'pointer';
            return;
        }
        
        fetch(`{% url 'forum:toggle_topic_subscribe' 'SLUG_PLACEHOLDER' %}`.replace('SLUG_PLACEHOLDER', slug), {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json',
            },
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || `Erreur HTTP: ${response.status}`);
                });
            }
            return response.json();
        })
        .then(data => {
            if (!data.success) {
                throw new Error(data.error || 'Erreur lors de l\'abonnement');
            }
            
            // Mettre à jour l'interface
            if (data.is_subscribed) {
                // S'abonner
                btn.classList.remove('text-white', 'bg-white/5', 'hover:bg-white/10');
                btn.classList.add('text-yellow-400', 'bg-yellow-400/20', 'hover:bg-yellow-400/30');
                text.textContent = 'Se désabonner';
                // Mettre à jour l'icône
                const icon = btn.querySelector('svg path');
                if (icon) {
                    icon.setAttribute('d', 'M5 13l4 4L19 7');
                }
                // Retirer le style gris de la cardview
                if (topicCard) {
                    topicCard.classList.remove('opacity-60', 'grayscale');
                    topicCard.removeAttribute('data-unsubscribed');
                }
            } else {
                // Se désabonner
                btn.classList.remove('text-yellow-400', 'bg-yellow-400/20', 'hover:bg-yellow-400/30');
                btn.classList.add('text-white', 'bg-white/5', 'hover:bg-white/10');
                text.textContent = 'S\'abonner';
                // Mettre à jour l'icône
                const icon = btn.querySelector('svg path');
                if (icon) {
                    icon.setAttribute('d', 'M12 4v16m8-8H4');
                }
                // Ajouter le style gris à la cardview
                if (topicCard) {
                    topicCard.classList.add('opacity-60', 'grayscale');
                    topicCard.setAttribute('data-unsubscribed', 'true');
                    // Réinitialiser le swipe to delete pour cette carte
                    setTimeout(() => {
                        initSwipeToDelete();
                    }, 100);
                }
            }
            
            // Mettre à jour le compteur d'abonnés si présent
            const subscribersCount = document.querySelector(`[data-topic-subscribers="${topicId}"]`);
            if (subscribersCount && data.subscribers_count !== undefined) {
                subscribersCount.textContent = `${data.subscribers_count} abonné${data.subscribers_count > 1 ? 's' : ''}`;
                subscribersCount.style.display = data.subscribers_count > 0 ? 'inline' : 'none';
            }
            
            showNotification(data.message || 'Action effectuée avec succès', 'success');
            btn.disabled = false;
            btn.style.opacity = '1';
            btn.style.cursor = 'pointer';
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification(error.message || 'Erreur lors de l\'abonnement', 'error');
            text.textContent = originalText;
            btn.className = originalClasses;
            btn.disabled = false;
            btn.style.opacity = '1';
            btn.style.cursor = 'pointer';
        });
    }
    
    // Fonction pour supprimer un topic de la liste (masquer visuellement)
    function removeTopicFromList(slug, topicId, buttonElement) {
        // Fermer la boîte de dialogue si elle est ouverte
        if (buttonElement) {
            const dialog = buttonElement.closest('[x-data]');
            if (dialog && typeof Alpine !== 'undefined' && Alpine.$data) {
                try {
                    const alpineData = Alpine.$data(dialog);
                    if (alpineData && typeof alpineData.showMenu !== 'undefined') {
                        alpineData.showMenu = false;
                    }
                } catch (e) {
                    console.log('Dialog already closed or not Alpine managed');
                }
            }
        }
        
        // Trouver la cardview du topic
        const topicCard = document.querySelector(`[data-topic-id="${topicId}"]`);
        const topicCardWrapper = topicCard?.closest('.topic-card-wrapper');
        
        if (topicCardWrapper) {
            // Animation de sortie
            topicCard.classList.add('swiped-out');
            setTimeout(() => {
                topicCardWrapper.style.display = 'none';
                showNotification('Forum retiré de votre liste', 'success');
            }, 300);
        } else {
            showNotification('Erreur: forum non trouvé', 'error');
        }
    }
    
    // Fonction pour afficher des notifications
    function showNotification(message, type = 'info') {
        // Créer l'élément de notification
        const notification = document.createElement('div');
        notification.className = `fixed top-20 right-4 z-50 px-6 py-4 rounded-xl shadow-2xl backdrop-blur-xl border ${
            type === 'success' ? 'bg-green-500/90 border-green-400 text-white' :
            type === 'error' ? 'bg-red-500/90 border-red-400 text-white' :
            'bg-blue-500/90 border-blue-400 text-white'
        } transform transition-all duration-300 animate-fade-in`;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        // Retirer après 3 secondes
        setTimeout(() => {
            notification.style.opacity = '0';
            notification.style.transform = 'translateX(100%)';
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 300);
        }, 3000);
    }
    
    // Gestion des formulaires d'abonnement aux groupes
    document.addEventListener('DOMContentLoaded', function() {
        const groupForms = document.querySelectorAll('form[action*="toggle_group_subscribe"]');
        
        groupForms.forEach(form => {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(form);
                const button = form.querySelector('button[type="submit"]');
                const originalText = button.textContent;
                
                // Désactiver le bouton
                button.disabled = true;
                button.textContent = 'Chargement...';
                
                fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Afficher le message
                        showNotification(data.message, 'success');
                        
                        // Recharger la page après un court délai
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        showNotification(data.message || 'Une erreur est survenue', 'error');
                        button.disabled = false;
                        button.textContent = originalText;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification('Une erreur est survenue', 'error');
                    button.disabled = false;
                    button.textContent = originalText;
                });
            });
        });
    });
</script>
{% endblock %}
