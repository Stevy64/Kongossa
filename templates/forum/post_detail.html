{% extends 'base.html' %}
{% load static %}

{% block title %}Post - Kongossa{% endblock %}

{% block content %}
<div class="min-h-screen bg-blurred pb-20">
    <!-- Header -->
    <div class="glass-dark tab-bar sticky top-0 z-40 backdrop-blur-xl">
        <div class="max-w-2xl mx-auto px-4 py-4 flex items-center justify-between">
            <a href="/feed/" class="text-white">‚Üê Retour</a>
            <h1 class="text-white text-xl font-poppins font-bold">Post</h1>
            <div></div>
        </div>
    </div>
    
    <div class="max-w-2xl mx-auto px-4 py-6">
        <div class="glass rounded-3xl p-4 mb-4">
            <!-- Post Header -->
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center space-x-3">
                    <a href="{% url 'users:profile' post.author.username %}">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 flex items-center justify-center overflow-hidden">
                            {% if post.author.avatar %}
                                <img src="{{ post.author.avatar.url }}" alt="{{ post.author.username }}" class="w-full h-full object-cover">
                            {% else %}
                                <span class="text-white text-sm font-bold">{{ post.author.username|first|upper }}</span>
                            {% endif %}
                        </div>
                    </a>
                    <div>
                        <a href="{% url 'users:profile' post.author.username %}" class="text-white font-medium hover:underline">
                            {{ post.author.username }}
                        </a>
                        <p class="text-gray-400 text-xs">{{ post.created_at|timesince }} ago</p>
                    </div>
                </div>
            </div>
            
            <!-- Post Content -->
            {% if post.content %}
                <p class="text-white mb-3 whitespace-pre-wrap">{{ post.content }}</p>
            {% endif %}
            
            <!-- Post Image -->
            {% if post.image %}
                <img src="{{ post.image.url }}" alt="Post image" class="w-full rounded-2xl mb-3 cursor-pointer" onclick="window.open(this.src, '_blank')">
            {% endif %}
            
            <!-- Post Actions -->
            <div class="flex items-center space-x-6 pt-3 border-t border-white/10">
                <button 
                    onclick="toggleLike({{ post.id }})"
                    class="flex items-center space-x-2 text-gray-400 hover:text-pink-500 transition"
                    id="like-btn-{{ post.id }}"
                >
                    <span class="text-xl" id="like-icon-{{ post.id }}">
                        {% if is_liked %}‚ù§Ô∏è{% else %}ü§ç{% endif %}
                    </span>
                    <span id="like-count-{{ post.id }}">{{ post.like_count }}</span>
                </button>
                
                <div class="flex items-center space-x-2 text-gray-400">
                    <span class="text-xl">üí¨</span>
                    <span>{{ post.comment_count }}</span>
                </div>
            </div>
        </div>
        
        <!-- Comments Section -->
        <div class="glass rounded-3xl p-4">
            <h3 class="text-white font-semibold mb-4">Commentaires</h3>
            
            <div id="comments-list" class="space-y-3 mb-4">
                {% for comment in post.comments.all %}
                    <div class="glass rounded-2xl p-3">
                        <div class="flex items-center space-x-2 mb-1">
                            <span class="text-white font-medium text-sm">{{ comment.author.username }}</span>
                            <span class="text-gray-400 text-xs">{{ comment.created_at|timesince }} ago</span>
                        </div>
                        <p class="text-white text-sm">{{ comment.content }}</p>
                    </div>
                {% empty %}
                    <p class="text-gray-400 text-sm text-center">Aucun commentaire pour le moment</p>
                {% endfor %}
            </div>
            
            <form onsubmit="addComment(event, {{ post.id }})" class="flex space-x-2">
                <input 
                    type="text" 
                    id="comment-input-{{ post.id }}"
                    placeholder="Ajouter un commentaire..."
                    class="flex-1 px-4 py-2 rounded-full bg-white/10 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm"
                >
                <button 
                    type="submit"
                    class="btn-pill bg-purple-600 text-white text-sm"
                >
                    Envoyer
                </button>
            </form>
        </div>
    </div>
</div>

<script>
    function toggleLike(postId) {
        fetch(`/feed/post/${postId}/like/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            const icon = document.getElementById(`like-icon-${postId}`);
            const count = document.getElementById(`like-count-${postId}`);
            icon.textContent = data.liked ? '‚ù§Ô∏è' : 'ü§ç';
            count.textContent = data.like_count;
        });
    }
    
    function addComment(event, postId) {
        event.preventDefault();
        const input = document.getElementById(`comment-input-${postId}`);
        const content = input.value.trim();
        
        if (!content) return;
        
        fetch(`/feed/post/${postId}/comment/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: new FormData(event.target.closest('form'))
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const commentsList = document.getElementById('comments-list');
                const commentHtml = `
                    <div class="glass rounded-2xl p-3">
                        <div class="flex items-center space-x-2 mb-1">
                            <span class="text-white font-medium text-sm">${data.comment.author}</span>
                            <span class="text-gray-400 text-xs">${data.comment.created_at}</span>
                        </div>
                        <p class="text-white text-sm">${data.comment.content}</p>
                    </div>
                `;
                commentsList.insertAdjacentHTML('beforeend', commentHtml);
                input.value = '';
            }
        });
    }
</script>
{% endblock %}

