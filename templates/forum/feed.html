{% extends 'base.html' %}
{% load static %}

{% block title %}Fil d'actualit√© - Kongossa{% endblock %}

{% block extra_css %}
<style>
    /* Smooth scrolling */
    html {
        scroll-behavior: smooth;
    }
    
    body {
        scroll-behavior: smooth;
    }
    
    /* Chat Popup Styles */
    #chat-popup-overlay {
        animation: fadeIn 0.3s ease-out;
    }
    
    #chat-popup-container {
        animation: slideUp 0.3s ease-out;
    }
    
    @keyframes fadeIn {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }
    
    @keyframes slideUp {
        from {
            transform: translateY(20px) scale(0.95);
            opacity: 0;
        }
        to {
            transform: translateY(0) scale(1);
            opacity: 1;
        }
    }
    
    #chat-popup-iframe {
        background: transparent;
    }
    /* Skeleton Loader Styles */
    .skeleton-post {
        background: rgba(27, 38, 59, 0.6);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 1.5rem;
        padding: 1.25rem;
        box-shadow: 0 8px 32px rgba(13, 27, 42, 0.4);
    }

    .skeleton-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }

    .skeleton-avatar {
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 50%;
        background: linear-gradient(90deg, #1f1f1f 0%, #2a2a2a 50%, #1f1f1f 100%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
        flex-shrink: 0;
    }

    .skeleton-text-group {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .skeleton-line {
        height: 0.75rem;
        border-radius: 0.5rem;
        background: linear-gradient(90deg, #1f1f1f 0%, #2a2a2a 50%, #1f1f1f 100%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
    }

    .skeleton-line-title {
        width: 40%;
        height: 1rem;
    }

    .skeleton-line-subtitle {
        width: 30%;
        height: 0.625rem;
    }

    .skeleton-line-short {
        width: 60%;
    }

    .skeleton-content {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }

    .skeleton-actions {
        display: flex;
        gap: 2rem;
        padding-top: 1rem;
        border-top: 1px solid rgba(255, 255, 255, 0.2);
    }

    .skeleton-button {
        width: 4rem;
        height: 2rem;
        border-radius: 9999px;
        background: linear-gradient(90deg, #1f1f1f 0%, #2a2a2a 50%, #1f1f1f 100%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
    }

    @keyframes shimmer {
        0% {
            background-position: -200% 0;
        }
        100% {
            background-position: 200% 0;
        }
    }
    
    @keyframes fade-in {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .animate-fade-in {
        animation: fade-in 0.3s ease-out;
    }

    /* Fade-in animation pour les nouveaux posts */
    .fade-in-post {
        animation: fadeInPost 0.5s ease-in;
    }

    @keyframes fadeInPost {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Masquer le skeleton par d√©faut */
    #skeleton-loader.hidden {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-blurred pb-20">
    <!-- Header - Tab bar plus fonc√©e -->
    <div class="glass-dark tab-bar sticky top-0 z-40 backdrop-blur-xl border-b border-white/10">
        <div class="max-w-2xl mx-auto px-4 py-4 flex items-center justify-between">
            <h1 class="text-white text-xl font-calligraphy">Kongossa</h1>
            <div class="flex items-center space-x-3">
                <!-- Notifications Button -->
                <a href="{% url 'notifications:list' %}" class="relative group">
                    <div class="relative p-2 rounded-xl bg-white/10 hover:bg-white/20 border border-white/20 transition-all duration-300 hover:scale-110">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                        </svg>
                        {% if unread_notifications_count > 0 %}
                        <span class="absolute -top-1 -right-1 w-5 h-5 rounded-full bg-gold flex items-center justify-center text-brand-primary text-xs font-bold shadow-gold animate-pulse">
                            {% if unread_notifications_count > 9 %}9+{% else %}{{ unread_notifications_count }}{% endif %}
                        </span>
                        {% endif %}
                    </div>
                </a>
                
                <!-- Forums Button -->
                <a href="{% url 'forum:topics_list' %}" class="relative group">
                    <div class="flex items-center space-x-2 px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20 border border-white/20 transition-all duration-300 hover:scale-105">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                    </svg>
                        <span class="text-white text-sm font-medium hidden sm:inline">Forums</span>
                    </div>
                    <div class="absolute -bottom-1 left-1/2 transform -translate-x-1/2 w-0 h-0.5 bg-gold group-hover:w-full transition-all duration-300"></div>
                </a>
                
                <!-- Profile Button -->
                <a href="{% url 'users:profile' user.username %}" class="p-1 rounded-xl hover:bg-white/10 transition-all duration-300 hover:scale-110">
                    <div class="w-8 h-8 rounded-xl bg-gradient-gold flex items-center justify-center overflow-hidden shadow-gold">
                        {% if user.avatar %}
                            <img src="{{ user.avatar.url }}" alt="{{ user.username }}" class="w-full h-full object-cover">
                        {% else %}
                            <span class="text-brand-primary text-xs font-bold">{{ user.username|first|upper }}</span>
                        {% endif %}
                    </div>
                </a>
            </div>
        </div>
    </div>
    
    <div class="max-w-2xl mx-auto px-4 py-6">
        <!-- Stories Carousel - Toujours affich√© -->
        {% include 'stories/carousel.html' with users_with_stories=users_with_stories|default:"" %}
        
        <!-- Create Post Form -->
        <div class="glass-enhanced rounded-3xl p-5 mb-6 border border-white/20 shadow-2xl" x-data="{ showForm: false }">
            <div class="flex items-center space-x-3">
                <div class="w-12 h-12 rounded-2xl bg-gradient-gold flex items-center justify-center overflow-hidden shadow-gold">
                    {% if user.avatar %}
                        <img src="{{ user.avatar.url }}" alt="{{ user.username }}" class="w-full h-full object-cover">
                    {% else %}
                        <span class="text-brand-primary text-lg font-bold">{{ user.username|first|upper }}</span>
                    {% endif %}
                </div>
                <button 
                    @click="showForm = !showForm"
                    class="flex-1 text-left px-5 py-3 rounded-2xl bg-white/10 text-gray-300 hover:bg-white/20 transition-all duration-300 hover:scale-[1.02] backdrop-blur-sm border border-white/20"
                >
                    <span class="text-sm">Quoi de neuf ?</span>
                </button>
            </div>
            
            <div x-show="showForm" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 transform translate-y-2" x-transition:enter-end="opacity-100 transform translate-y-0" class="mt-5 space-y-4 pt-5 border-t border-white/20">
                <form method="POST" action="{% url 'forum:create_post' %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    <textarea 
                        name="content" 
                        rows="4"
                        class="w-full px-5 py-4 rounded-2xl bg-white/10 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-gold focus:border-transparent resize-none backdrop-blur-sm transition-all"
                        placeholder="Partagez vos pens√©es, vos id√©es, vos moments..."
                    ></textarea>
                    
                    <div class="flex items-center justify-between flex-wrap gap-2">
                        <div class="flex items-center gap-2 flex-wrap">
                            <label class="cursor-pointer btn-interactive">
                                <input type="file" name="image" accept="image/*" class="hidden" id="post-image-input">
                                <span class="px-4 py-2 rounded-full glass text-white/90 hover:text-white hover:bg-white/20 transition-all flex items-center space-x-2 text-sm font-medium">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                    </svg>
                                    <span>Photo</span>
                                </span>
                            </label>
                            <label class="cursor-pointer btn-interactive">
                                <input type="file" name="video" accept="video/*" class="hidden" id="post-video-input">
                                <span class="px-4 py-2 rounded-full glass text-white/90 hover:text-white hover:bg-white/20 transition-all flex items-center space-x-2 text-sm font-medium">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                    </svg>
                                    <span>Vid√©o</span>
                                </span>
                            </label>
                            <label class="cursor-pointer btn-interactive">
                                <input type="file" name="audio" accept="audio/*" class="hidden" id="post-audio-input">
                                <span class="px-4 py-2 rounded-full glass text-white/90 hover:text-white hover:bg-white/20 transition-all flex items-center space-x-2 text-sm font-medium">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
                                    </svg>
                                    <span>Audio</span>
                                </span>
                        </label>
                        </div>
                        <button 
                            type="submit"
                            class="btn-pill bg-gradient-gold text-brand-primary text-sm font-semibold hover:shadow-gold hover:scale-105 transition-all btn-interactive font-bold"
                        >
                            Publier
                        </button>
                    </div>
                    <div id="post-media-preview" class="hidden mt-3 space-y-2">
                        <div id="post-image-preview" class="hidden">
                            <img id="post-preview-img" src="" alt="Preview" class="max-w-full h-48 object-cover rounded-2xl border border-white/20 shadow-lg">
                        </div>
                        <div id="post-video-preview" class="hidden">
                            <video id="post-preview-video" src="" controls class="max-w-full h-48 rounded-2xl border border-white/20 shadow-lg"></video>
                        </div>
                        <div id="post-audio-preview" class="hidden">
                            <audio id="post-preview-audio" src="" controls class="w-full rounded-2xl"></audio>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        
        <script>
            // Media preview for post creation
            document.getElementById('post-image-input')?.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Reset other previews
                    document.getElementById('post-video-preview').classList.add('hidden');
                    document.getElementById('post-audio-preview').classList.add('hidden');
                    document.getElementById('post-video-input').value = '';
                    document.getElementById('post-audio-input').value = '';
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('post-preview-img').src = e.target.result;
                        document.getElementById('post-image-preview').classList.remove('hidden');
                        document.getElementById('post-media-preview').classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            document.getElementById('post-video-input')?.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Reset other previews
                    document.getElementById('post-image-preview').classList.add('hidden');
                    document.getElementById('post-audio-preview').classList.add('hidden');
                    document.getElementById('post-image-input').value = '';
                    document.getElementById('post-audio-input').value = '';
                    
                    const url = URL.createObjectURL(file);
                    document.getElementById('post-preview-video').src = url;
                    document.getElementById('post-video-preview').classList.remove('hidden');
                    document.getElementById('post-media-preview').classList.remove('hidden');
                }
            });
            
            document.getElementById('post-audio-input')?.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Reset other previews
                    document.getElementById('post-image-preview').classList.add('hidden');
                    document.getElementById('post-video-preview').classList.add('hidden');
                    document.getElementById('post-image-input').value = '';
                    document.getElementById('post-video-input').value = '';
                    
                    const url = URL.createObjectURL(file);
                    document.getElementById('post-preview-audio').src = url;
                    document.getElementById('post-audio-preview').classList.remove('hidden');
                    document.getElementById('post-media-preview').classList.remove('hidden');
                }
            });
        </script>
        
        <!-- Posts Feed -->
        <div class="space-y-5 mt-5" id="posts-container">
            {% for post in page_obj %}
                <!-- CardView Moderne -->
                <div class="w-full bg-white/85 backdrop-blur-sm rounded-3xl shadow-xl p-4 hover:shadow-2xl transition-all duration-300 hover:scale-[1.01] stagger-item" data-post-id="{{ post.id }}">
                    <!-- Post Header -->
                    <div class="flex items-center space-x-3 mb-3">
                            <a href="{% url 'users:profile' post.author.username %}">
                            <div class="w-10 h-10 rounded-full overflow-hidden flex-shrink-0 shadow-md border-2 border-white/50">
                                    {% if post.author.avatar %}
                                    <img src="{{ post.author.avatar.url }}" alt="{{ post.author.username }}" class="w-full h-full object-cover" loading="lazy">
                                    {% else %}
                                    <div class="w-full h-full bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center">
                                        <span class="text-white text-sm font-bold">{{ post.author.username|first|upper }}</span>
                                    </div>
                                    {% endif %}
                                </div>
                            </a>
                        <div class="flex flex-col leading-tight flex-1 min-w-0">
                            <a href="{% url 'users:profile' post.author.username %}" class="font-semibold text-gray-900 hover:text-blue-600 transition-colors truncate">
                                    {{ post.author.username }}
                                </a>
                            <span class="text-xs text-gray-500 truncate">@{{ post.author.username|lower }}</span>
                            </div>
                        <span class="text-xs text-gray-400 flex-shrink-0">{{ post.created_at|timesince }}</span>
                    </div>
                    
                    <!-- Post Content -->
                    {% if post.content %}
                        <p class="mt-3 text-gray-700 whitespace-pre-wrap leading-relaxed">{{ post.content }}</p>
                    {% endif %}
                    
                    <!-- Post Media -->
                    {% if post.image %}
                        <img src="{{ post.image.url }}" alt="Post image" class="w-full rounded-2xl mt-3 cursor-pointer object-cover max-h-96" onclick="window.open(this.src, '_blank')" loading="lazy">
                    {% endif %}
                    {% if post.video %}
                        <video src="{{ post.video.url }}" controls class="w-full rounded-2xl mt-3 max-h-96 object-contain bg-gray-100" loading="lazy">
                            Votre navigateur ne supporte pas la lecture de vid√©os.
                        </video>
                    {% endif %}
                    {% if post.audio %}
                        <div class="mt-3 rounded-2xl bg-gray-50 p-4 border border-gray-200">
                            <audio src="{{ post.audio.url }}" controls class="w-full">
                                Votre navigateur ne supporte pas la lecture audio.
                            </audio>
                        </div>
                    {% endif %}
                    
                    <!-- Post Actions Footer -->
                    <div class="flex items-center justify-between mt-4 pt-4 border-t border-gray-200 text-gray-600 text-sm">
                        <button 
                            onclick="toggleLike({{ post.id }})"
                            class="flex items-center space-x-1 hover:text-red-500 transition-all duration-300 hover:scale-110 btn-interactive px-2 py-1 rounded-lg hover:bg-red-50"
                            id="like-btn-{{ post.id }}"
                        >
                            <svg class="w-5 h-5 transform transition-transform duration-300" id="like-icon-{{ post.id }}" fill="{% if post.id in liked_posts %}currentColor{% else %}none{% endif %}" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                            </svg>
                            <span class="font-medium" id="like-count-{{ post.id }}">{{ post.like_count }}</span>
                        </button>
                        
                        <button 
                            onclick="toggleComments({{ post.id }})"
                            class="flex items-center space-x-1 hover:text-green-500 transition-all duration-300 hover:scale-110 btn-interactive px-2 py-1 rounded-lg hover:bg-green-50"
                            id="comment-btn-{{ post.id }}"
                        >
                            <svg class="w-5 h-5 transform transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                            </svg>
                            <span class="font-medium" id="comment-count-{{ post.id }}">{{ post.comment_count }}</span>
                        </button>
                        
                        <button 
                            class="flex items-center justify-center hover:text-blue-500 transition-all duration-300 hover:scale-110 btn-interactive px-2 py-1 rounded-lg hover:bg-blue-50"
                            onclick="sharePost({{ post.id }})"
                            title="Partager"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Comments Section -->
                    <div id="comments-{{ post.id }}" class="hidden mt-5 space-y-4 pt-4 border-t border-gray-200">
                        <div id="comments-list-{{ post.id }}" class="space-y-3 max-h-60 overflow-y-auto pr-2">
                            {% for comment in post.comments.all %}
                                <div class="bg-gray-50 rounded-2xl p-3 comment-item border border-gray-200 hover:bg-gray-100 transition-colors">
                                    <div class="flex items-center space-x-2 mb-2">
                                        <div class="w-8 h-8 rounded-full overflow-hidden flex-shrink-0 shadow-sm border border-gray-300">
                                            {% if comment.author.avatar %}
                                                <img src="{{ comment.author.avatar.url }}" alt="{{ comment.author.username }}" class="w-full h-full object-cover" loading="lazy">
                                            {% else %}
                                                <div class="w-full h-full bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center">
                                                    <span class="text-white text-xs font-bold">{{ comment.author.username|first|upper }}</span>
                                                </div>
                                            {% endif %}
                                        </div>
                                        <span class="text-gray-900 font-semibold text-sm">{{ comment.author.username }}</span>
                                        <span class="text-gray-400 text-xs">¬∑</span>
                                        <span class="text-gray-400 text-xs">{{ comment.created_at|timesince }}</span>
                                    </div>
                                    <p class="text-gray-700 text-sm leading-relaxed ml-10">{{ comment.content }}</p>
                                </div>
                            {% endfor %}
                        </div>
                        <form onsubmit="addComment(event, {{ post.id }})" class="flex space-x-3">
                            {% csrf_token %}
                            <input 
                                type="text" 
                                id="comment-input-{{ post.id }}"
                                name="content"
                                placeholder="Write a comment..."
                                class="flex-1 px-4 py-2.5 rounded-full bg-gray-50 border border-gray-200 text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm transition-all"
                            >
                            <button 
                                type="submit"
                                class="px-4 py-2.5 bg-blue-500 text-white rounded-full text-sm font-semibold hover:bg-blue-600 hover:scale-105 transition-all btn-interactive shadow-sm"
                            >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                                </svg>
                            </button>
                        </form>
                    </div>
                </div>
            {% empty %}
                <div class="bg-white/85 backdrop-blur-sm rounded-3xl p-12 text-center border border-gray-200 shadow-xl fade-in-up">
                    <div class="flex justify-center mb-4">
                        <svg class="w-16 h-16 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 001.423 1.423l1.183.394-1.183.394a2.25 2.25 0 00-1.423 1.423z" />
                        </svg>
                    </div>
                    <p class="text-gray-900 text-lg mb-2 font-semibold">Aucun post pour le moment</p>
                    <p class="text-gray-600 text-sm">Soyez le premier √† publier et partagez vos pens√©es avec la communaut√© !</p>
                </div>
            {% endfor %}
        </div>
        
        <!-- Skeleton Loader (masqu√© par d√©faut) -->
        <div id="skeleton-loader" class="hidden space-y-5 mt-5">
            {% for i in "123" %}
            <div class="skeleton-post">
                <div class="skeleton-header">
                    <div class="skeleton-avatar"></div>
                    <div class="skeleton-text-group">
                        <div class="skeleton-line skeleton-line-title"></div>
                        <div class="skeleton-line skeleton-line-subtitle"></div>
                    </div>
                </div>
                <div class="skeleton-content">
                    <div class="skeleton-line"></div>
                    <div class="skeleton-line skeleton-line-short"></div>
                </div>
                <div class="skeleton-actions">
                    <div class="skeleton-button"></div>
                    <div class="skeleton-button"></div>
                </div>
                </div>
            {% endfor %}
        </div>
        
        <!-- Sentinel pour Infinite Scroll -->
        <div id="sentinel" class="h-10 w-full"></div>
        
        <!-- Message de fin (sera ajout√© dynamiquement) -->
        <div id="end-of-feed-message" class="hidden text-center mt-8">
            <div class="glass-enhanced rounded-3xl p-6 border border-white/20">
                <p class="text-white/70 text-sm">Vous avez atteint la fin du fil d'actualit√©</p>
            </div>
    </div>
    </div>
    
    <!-- Floating Chat Button (FAB) -->
    <button 
        id="chat-fab-button"
        onclick="openChatPopup()"
        class="fixed bottom-6 right-6 z-50 group"
    >
        <div class="relative">
            <div class="absolute inset-0 bg-gradient-gold rounded-full blur-lg opacity-50 group-hover:opacity-75 transition-opacity duration-300 animate-pulse"></div>
            <div class="relative w-14 h-14 bg-gradient-gold rounded-full flex items-center justify-center shadow-gold-lg hover:shadow-gold transition-all duration-300 hover:scale-110 hover:rotate-12">
                <svg class="w-7 h-7 text-brand-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 8.511c.884.284 1.5 1.128 1.5 2.097v4.286c0 1.136-.847 2.1-1.98 2.193-.34.027-.68.052-1.02.072v3.091l-3-3c-1.354 0-2.694-.055-4.02-.163a2.115 2.115 0 01-.825-.242m9.345-8.334a2.126 2.126 0 00-.476-.095 48.64 48.64 0 00-8.048 0c-1.131.094-1.976 1.057-1.976 2.192v4.286c0 .837.46 1.58 1.155 1.951m9.345-8.334V6.637c0-1.621-1.152-3.026-2.76-3.235A48.455 48.455 0 0011.25 3c-2.115 0-4.198.137-6.24.402-1.608.209-2.76 1.614-2.76 3.235v6.226c0 1.621 1.152 3.026 2.76 3.235.577.075 1.157.14 1.74.194V21l4.155-4.155" />
                </svg>
                <!-- Badge compteur de messages non lus -->
                <span id="chat-unread-badge" class="absolute -top-1 -right-1 min-w-[20px] h-5 px-1.5 rounded-full bg-red-500 flex items-center justify-center text-white text-xs font-bold shadow-lg hidden">
                    <span id="chat-unread-count">0</span>
                </span>
            </div>
        </div>
    </button>
    
    <!-- Chat Popup Overlay -->
    <div 
        id="chat-popup-overlay"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] hidden items-center justify-center p-4"
        onclick="closeChatPopup(event)"
    >
        <!-- Chat Popup Container -->
        <div 
            id="chat-popup-container"
            class="w-full h-full max-w-6xl max-h-[90vh] bg-telegram-surface/95 backdrop-blur-xl rounded-3xl shadow-2xl border border-white/20 overflow-hidden flex flex-col transform scale-95 opacity-0 transition-all duration-300"
            onclick="event.stopPropagation()"
        >
            <!-- Chat Header -->
            <div class="flex items-center justify-between p-4 border-b border-white/10 bg-telegram-surface/98 backdrop-blur-xl">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-gold via-yellow-400 to-gold flex items-center justify-center flex-shrink-0 shadow-lg">
                        <span class="text-xl">üí¨</span>
                    </div>
                    <h2 class="text-telegram-text font-semibold text-lg">Messages</h2>
                </div>
                <button 
                    onclick="closeChatPopup()"
                    class="p-2 rounded-lg hover:bg-white/10 text-telegram-text-secondary transition-colors"
                    title="Fermer"
                >
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <!-- Chat Content (iframe) -->
            <iframe 
                id="chat-popup-iframe"
                src="{% url 'chat:list' %}"
                class="flex-1 w-full border-0"
                frameborder="0"
            ></iframe>
        </div>
    </div>
</div>

<script>
    function toggleLike(postId) {
        fetch(`{% url 'forum:toggle_like' 0 %}`.replace('0', postId), {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            const icon = document.getElementById(`like-icon-${postId}`);
            const count = document.getElementById(`like-count-${postId}`);
            const btn = document.getElementById(`like-btn-${postId}`);
            
            if (data.liked) {
                icon.setAttribute('fill', 'currentColor');
                icon.classList.add('text-red-500');
                icon.classList.remove('text-gray-300');
                btn.classList.add('text-red-500');
                btn.classList.remove('text-gray-300');
            } else {
                icon.setAttribute('fill', 'none');
                icon.classList.remove('text-red-500');
                icon.classList.add('text-gray-300');
                btn.classList.remove('text-red-500');
                btn.classList.add('text-gray-300');
            }
            count.textContent = data.like_count;
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
    
    function toggleComments(postId) {
        const commentsDiv = document.getElementById(`comments-${postId}`);
        const commentBtn = document.getElementById(`comment-btn-${postId}`);
        const isHidden = commentsDiv.classList.contains('hidden');
        commentsDiv.classList.toggle('hidden');
        
        // Changer la couleur du bouton quand les commentaires sont d√©ploy√©s
        if (isHidden) {
            // Commentaires d√©ploy√©s - vert clair
            commentBtn.classList.add('text-green-400');
            commentBtn.classList.remove('text-gray-300');
        } else {
            // Commentaires masqu√©s - gris
            commentBtn.classList.remove('text-green-400');
            commentBtn.classList.add('text-gray-300');
        }
        
        // Charger les commentaires si c'est la premi√®re fois
        if (isHidden && commentsDiv.querySelector('#comments-list-'+postId).children.length === 0) {
            loadComments(postId);
        }
    }
    
    function loadComments(postId) {
        fetch(`{% url 'forum:post_detail' 0 %}`.replace('0', postId))
            .then(response => response.text())
            .then(html => {
                // Extraire les commentaires du HTML (simplifi√©, id√©alement utiliser une API)
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const comments = doc.querySelectorAll('.comment-item');
                const commentsList = document.getElementById(`comments-list-${postId}`);
                
                comments.forEach(comment => {
                    commentsList.appendChild(comment.cloneNode(true));
                });
            });
    }
    
    function addComment(event, postId) {
        event.preventDefault();
        const input = document.getElementById(`comment-input-${postId}`);
        const content = input.value.trim();
        
        if (!content) return;
        
        const form = event.target.closest('form');
        const formData = new FormData(form);
        formData.append('content', content);
        
        fetch(`{% url 'forum:add_comment' 0 %}`.replace('0', postId), {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const commentsList = document.getElementById(`comments-list-${postId}`);
                const commentHtml = `
                    <div class="bg-gray-50 rounded-2xl p-3 comment-item border border-gray-200 hover:bg-gray-100 transition-colors">
                        <div class="flex items-center space-x-2 mb-2">
                            <div class="w-8 h-8 rounded-full overflow-hidden flex-shrink-0 shadow-sm border border-gray-300">
                                <div class="w-full h-full bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center">
                                    <span class="text-white text-xs font-bold">${escapeHtml(data.comment.author).charAt(0).toUpperCase()}</span>
                                </div>
                            </div>
                            <span class="text-gray-900 font-semibold text-sm">${escapeHtml(data.comment.author)}</span>
                            <span class="text-gray-400 text-xs">¬∑</span>
                            <span class="text-gray-400 text-xs">${data.comment.created_at}</span>
                        </div>
                        <p class="text-gray-700 text-sm leading-relaxed ml-10">${escapeHtml(data.comment.content)}</p>
                    </div>
                `;
                commentsList.insertAdjacentHTML('beforeend', commentHtml);
                document.getElementById(`comment-count-${postId}`).textContent = data.comment_count;
                input.value = '';
                // Scroll to the new comment
                commentsList.scrollTop = commentsList.scrollHeight;
            } else if (data.error) {
                alert(data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erreur lors de l\'ajout du commentaire');
        });
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Fonction pour partager un post
    async function sharePost(postId) {
        const shareUrl = `${window.location.origin}{% url 'forum:post_detail' 0 %}`.replace('0', postId);
        const shareTitle = 'Voir ce post sur Kongossa';
        const shareText = 'D√©couvrez ce post int√©ressant sur Kongossa !';
        
        // Utiliser l'API Web Share si disponible (mobile)
        if (navigator.share) {
            try {
                await navigator.share({
                    title: shareTitle,
                    text: shareText,
                    url: shareUrl
                });
                return;
            } catch (err) {
                // L'utilisateur a annul√© le partage, on continue avec la m√©thode de fallback
                if (err.name !== 'AbortError') {
                    console.error('Erreur lors du partage:', err);
                }
            }
        }
        
        // Fallback : copier le lien dans le presse-papiers
        try {
            await navigator.clipboard.writeText(shareUrl);
            
            // Afficher une notification de succ√®s
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center space-x-2 animate-fade-in';
            notification.innerHTML = `
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                </svg>
                <span>Lien copi√© dans le presse-papiers !</span>
            `;
            document.body.appendChild(notification);
            
            // Supprimer la notification apr√®s 3 secondes
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        } catch (err) {
            console.error('Erreur lors de la copie:', err);
            // Fallback final : afficher le lien dans une alerte
            alert(`Partagez ce lien :\n${shareUrl}`);
        }
    }
    
    // Infinite Scroll avec IntersectionObserver
    (function() {
        {% if page_obj %}
        let currentPage = {{ page_obj.number|default:1 }};
        let isLoading = false;
        let hasMore = {{ page_obj.has_next|yesno:"true,false" }};
        {% else %}
        let currentPage = 1;
        let isLoading = false;
        let hasMore = false;
        {% endif %}
        const postsContainer = document.getElementById('posts-container');
        const skeletonLoader = document.getElementById('skeleton-loader');
        const sentinel = document.getElementById('sentinel');
        const endOfFeedMessage = document.getElementById('end-of-feed-message');
        
        // Observer pour d√©tecter quand le sentinel entre dans la vue
        if (sentinel && postsContainer && hasMore) {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    // D√©tecter quand le sentinel est visible (80-90% du bas)
                    if (entry.isIntersecting && !isLoading && hasMore) {
                        loadMorePosts();
                    }
                });
            }, {
                root: null,
                rootMargin: '200px',  // D√©clenche 200px avant d'atteindre le sentinel (80-90% du bas)
                threshold: 0.1
            });
            
            // Observer le sentinel
            observer.observe(sentinel);
            
            async function loadMorePosts() {
                if (isLoading || !hasMore) return;
                
                isLoading = true;
                currentPage++;
                
                // Afficher le skeleton loader
                if (skeletonLoader) {
                    skeletonLoader.classList.remove('hidden');
                }
                
                try {
                    const url = `{% url 'forum:feed' %}?page=${currentPage}&ajax=1`;
                    const response = await fetch(url, {
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Erreur lors du chargement');
                    }
                    
                    const html = await response.text();
                    
                    if (html.trim()) {
                        // Cr√©er un conteneur temporaire pour parser le HTML
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = html;
                        
                        // Ajouter les nouveaux posts avec animation
                        const newPosts = tempDiv.querySelectorAll('[data-post-id]');
                        newPosts.forEach((post, index) => {
                            post.classList.add('fade-in-post');
                            post.style.animationDelay = `${index * 0.1}s`;
                            postsContainer.appendChild(post);
                        });
                        
                        // V√©rifier s'il y a encore des pages
                        // On peut d√©tecter cela en v√©rifiant si moins de 10 posts ont √©t√© retourn√©s
                        if (newPosts.length < 10) {
                            hasMore = false;
                            if (endOfFeedMessage) {
                                endOfFeedMessage.classList.remove('hidden');
                            }
                            observer.unobserve(sentinel);
                        }
                    } else {
                        // Pas de contenu, on a atteint la fin
                        hasMore = false;
                        if (endOfFeedMessage) {
                            endOfFeedMessage.classList.remove('hidden');
                        }
                        observer.unobserve(sentinel);
                    }
                } catch (error) {
                    console.error('Erreur lors du chargement des posts:', error);
                    hasMore = false;
                } finally {
                    isLoading = false;
                    // Masquer le skeleton loader
                    if (skeletonLoader) {
                        skeletonLoader.classList.add('hidden');
                    }
                }
            }
        }
    })();
    
    // Fonction pour mettre √† jour le compteur de messages non lus
    function updateChatUnreadCount() {
        fetch('{% url "chat:unread_count" %}')
            .then(response => response.json())
            .then(data => {
                const badge = document.getElementById('chat-unread-badge');
                const count = document.getElementById('chat-unread-count');
                
                if (data.unread_count > 0) {
                    badge.classList.remove('hidden');
                    count.textContent = data.unread_count > 99 ? '99+' : data.unread_count;
                } else {
                    badge.classList.add('hidden');
                }
            })
            .catch(error => {
                console.error('Error fetching unread count:', error);
            });
    }
    
    // Mettre √† jour le compteur au chargement de la page
    document.addEventListener('DOMContentLoaded', function() {
        updateChatUnreadCount();
        // Mettre √† jour toutes les 10 secondes
        setInterval(updateChatUnreadCount, 10000);
    });
    
    // Chat Popup Functions
    function openChatPopup() {
        const overlay = document.getElementById('chat-popup-overlay');
        const container = document.getElementById('chat-popup-container');
        
        if (overlay && container) {
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');
            
            // Trigger animation after a small delay to ensure display
            setTimeout(() => {
                container.classList.remove('scale-95', 'opacity-0');
                container.classList.add('scale-100', 'opacity-100');
            }, 10);
            
            // Prevent body scroll when popup is open
            document.body.style.overflow = 'hidden';
        }
    }
    
    function closeChatPopup(event) {
        // Si l'√©v√©nement est pass√© et qu'on clique sur le container, ne pas fermer
        if (event && event.target.id === 'chat-popup-container') {
            return;
        }
        
        const overlay = document.getElementById('chat-popup-overlay');
        const container = document.getElementById('chat-popup-container');
        
        if (overlay && container) {
            // Animation de fermeture
            container.classList.remove('scale-100', 'opacity-100');
            container.classList.add('scale-95', 'opacity-0');
            
            // Masquer apr√®s l'animation
            setTimeout(() => {
                overlay.classList.add('hidden');
                overlay.classList.remove('flex');
                document.body.style.overflow = '';
            }, 300);
        }
    }
    
    // Fermer avec la touche Escape
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            const overlay = document.getElementById('chat-popup-overlay');
            if (overlay && !overlay.classList.contains('hidden')) {
                closeChatPopup();
            }
        }
    });
</script>
{% endblock %}

