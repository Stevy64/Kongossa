{% extends 'base.html' %}

{% block title %}Story - {{ story.user.username }} - Kongossa{% endblock %}

{% block extra_css %}
<style>
    .story-viewer {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 50;
        background: linear-gradient(135deg, #0D1B2A 0%, #1B263B 50%, #0D1B2A 100%);
        backdrop-filter: blur(20px);
    }
    
    .story-progress {
        height: 3px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 2px;
        overflow: hidden;
    }
    
    .story-progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #F0C419 0%, #F0C419 100%);
        transition: width 0.3s ease;
    }
</style>
{% endblock %}

{% block content %}
<div class="story-viewer" x-data="storyViewer()" x-init="init()">
    <div class="h-full flex flex-col relative">
        <!-- Story Progress Bar -->
        <div class="absolute top-0 left-0 right-0 z-10 p-2">
            <div class="max-w-md mx-auto space-y-1">
                {% for s in user_stories %}
                    <div class="story-progress">
                        <div 
                            class="story-progress-bar" 
                            :style="currentIndex === {{ forloop.counter0 }} ? 'width: ' + progress + '%' : 'width: {{ forloop.counter0|add:"-1" }} < currentIndex ? 100 : 0%'"
                        ></div>
                    </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Story Header -->
        <div class="glass-dark tab-bar px-4 py-4 flex items-center justify-between relative z-10 mt-12">
            <div class="flex items-center space-x-3">
                <a href="/feed/" class="text-white hover:text-gold transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                    </svg>
                </a>
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-400 to-green-500 p-0.5">
                    <div class="w-full h-full rounded-full bg-brand-primary flex items-center justify-center overflow-hidden">
                        {% if story.user.avatar %}
                            <img src="{{ story.user.avatar.url }}" alt="{{ story.user.username }}" class="w-full h-full object-cover">
                        {% else %}
                            <span class="text-white text-sm font-bold">{{ story.user.username|first|upper }}</span>
                        {% endif %}
                    </div>
                </div>
                <div>
                    <a href="{% url 'users:profile' story.user.username %}" class="text-white font-medium hover:text-gold transition-colors">{{ story.user.username }}</a>
                    <p class="text-gray-400 text-xs">{{ story.created_at|timesince }} ago</p>
                </div>
            </div>
            <a href="/feed/" class="text-white hover:text-red-500 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </a>
        </div>
        
        <!-- Story Content -->
        <div class="flex-1 flex items-center justify-center relative overflow-hidden">
            {% if story.image %}
                <div class="relative w-full h-full flex items-center justify-center">
                    <img src="{{ story.image.url }}" alt="Story" class="max-w-full max-h-full object-contain w-full h-full">
                    {% if story.content %}
                        <div class="absolute inset-0 flex items-center justify-center p-8">
                            <div class="bg-black/50 backdrop-blur-sm rounded-2xl px-6 py-4 max-w-md">
                                <p class="text-white text-lg font-medium whitespace-pre-wrap text-center">{{ story.content }}</p>
                            </div>
                        </div>
                    {% endif %}
                </div>
            {% elif story.video %}
                <div class="relative w-full h-full flex items-center justify-center">
                    <video 
                        src="{{ story.video.url }}" 
                        controls 
                        autoplay
                        class="max-w-full max-h-full w-full h-full object-contain"
                        @ended="nextStory()"
                    ></video>
                    {% if story.content %}
                        <div class="absolute bottom-8 left-0 right-0 flex items-center justify-center px-8">
                            <div class="bg-black/50 backdrop-blur-sm rounded-2xl px-6 py-4 max-w-md">
                                <p class="text-white text-lg font-medium whitespace-pre-wrap text-center">{{ story.content }}</p>
                            </div>
                        </div>
                    {% endif %}
                </div>
            {% elif story.content %}
                <div class="w-full h-full flex items-center justify-center p-8">
                    <div class="bg-gradient-to-br from-blue-600/90 to-green-600/90 backdrop-blur-sm rounded-3xl px-8 py-12 max-w-lg shadow-2xl border-2 border-white/20">
                        <p class="text-white text-2xl font-medium whitespace-pre-wrap text-center leading-relaxed">{{ story.content }}</p>
                    </div>
                </div>
            {% endif %}
            
            <!-- Navigation Areas (Clic gauche/droite) -->
            <div class="absolute left-0 top-0 bottom-0 w-1/2 cursor-pointer" @click="previousStory()"></div>
            <div class="absolute right-0 top-0 bottom-0 w-1/2 cursor-pointer" @click="nextStory()"></div>
            
            <!-- Navigation Arrows (visible on hover) -->
            <button 
                x-show="currentIndex > 0"
                @click="previousStory()"
                class="absolute left-4 text-white/80 hover:text-white text-4xl hover:scale-110 transition-all opacity-0 hover:opacity-100"
            >
                ‹
            </button>
            <button 
                x-show="currentIndex < totalStories - 1"
                @click="nextStory()"
                class="absolute right-4 text-white/80 hover:text-white text-4xl hover:scale-110 transition-all opacity-0 hover:opacity-100"
            >
                ›
            </button>
        </div>
    </div>
</div>

<script>
    function storyViewer() {
        return {
            currentIndex: {{ current_index }},
            totalStories: {{ user_stories|length }},
            progress: 0,
            progressInterval: null,
            stories: [
                {% for s in user_stories %}
                    { id: {{ s.id }}, url: '{% url "stories:viewer" s.id %}' }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ],
            init() {
                this.startProgress();
            },
            startProgress() {
                // Réinitialiser la progression
                this.progress = 0;
                
                // Démarrer la progression (5 secondes pour une story)
                if (this.progressInterval) {
                    clearInterval(this.progressInterval);
                }
                
                this.progressInterval = setInterval(() => {
                    this.progress += 2; // 2% toutes les 100ms = 5 secondes total
                    if (this.progress >= 100) {
                        clearInterval(this.progressInterval);
                        // Attendre un peu avant de passer à la suivante
                        setTimeout(() => {
                            this.nextStory();
                        }, 300);
                    }
                }, 100);
            },
            nextStory() {
                if (this.currentIndex < this.totalStories - 1) {
                    if (this.progressInterval) {
                        clearInterval(this.progressInterval);
                    }
                    window.location.href = this.stories[this.currentIndex + 1].url;
                } else {
                    // Retourner au feed si c'est la dernière story
                    window.location.href = '/feed/';
                }
            },
            previousStory() {
                if (this.currentIndex > 0) {
                    if (this.progressInterval) {
                        clearInterval(this.progressInterval);
                    }
                    window.location.href = this.stories[this.currentIndex - 1].url;
                }
            }
        }
    }
</script>
{% endblock %}
